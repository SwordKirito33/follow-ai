# Follow.ai å®Œæ•´ä¿®å¤æ‰§è¡Œæ‰‹å†Œ

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2026å¹´1æœˆ8æ—¥  
**GitHubä»“åº“**: SwordKirito33/follow-ai  
**ç›®æ ‡**: å°†ç»¼åˆè¯„åˆ†ä» 6.3/10 æå‡è‡³ 8.7/10  

---

## ç›®å½•

1. [ä¿®å¤é¡ºåºé€»è¾‘](#ä¸€ä¿®å¤é¡ºåºé€»è¾‘)
2. [Phase 1: åŸºç¡€è®¾æ–½å’Œç›‘æ§](#äºŒphase-1-åŸºç¡€è®¾æ–½å’Œç›‘æ§week-1)
3. [Phase 2: P0 Bug ä¿®å¤](#ä¸‰phase-2-p0-bug-ä¿®å¤week-2)
4. [Phase 3: æ ¸å¿ƒåŠŸèƒ½å®ç°](#å››phase-3-æ ¸å¿ƒåŠŸèƒ½å®ç°week-3-4)
5. [Phase 4: æ€§èƒ½å’ŒSEOä¼˜åŒ–](#äº”phase-4-æ€§èƒ½å’Œseoä¼˜åŒ–week-5-6)
6. [Phase 5: æ¸¸æˆåŒ–ç³»ç»Ÿ](#å…­phase-5-æ¸¸æˆåŒ–ç³»ç»Ÿweek-7-8)
7. [Phase 6: æµ‹è¯•å’Œæ”¶å°¾](#ä¸ƒphase-6-æµ‹è¯•å’Œæ”¶å°¾week-9-10)
8. [éªŒè¯æ¸…å•](#å…«éªŒè¯æ¸…å•)

---

## ä¸€ã€ä¿®å¤é¡ºåºé€»è¾‘

### 1.1 ä¾èµ–å…³ç³»å›¾

```
Phase 1: åŸºç¡€è®¾æ–½ (å¿…é¡»å…ˆå®Œæˆ)
    â”‚
    â”œâ”€â”€ Sentry é”™è¯¯ç›‘æ§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”œâ”€â”€ PostHog äº§å“åˆ†æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â””â”€â”€ Web Vitals ç›‘æ§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                      â”‚
Phase 2: P0 Bug ä¿®å¤ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚   (éœ€è¦ç›‘æ§æ¥éªŒè¯ä¿®å¤æ•ˆæœ)
    â”œâ”€â”€ ç™»å‡ºæµç¨‹ä¿®å¤
    â”œâ”€â”€ é€šçŸ¥é¢æ¿ä¿®å¤
    â”œâ”€â”€ è¡¨å•éªŒè¯ä¿®å¤
    â””â”€â”€ ä»£ç åˆ†å‰²é…ç½®
           â”‚
Phase 3: æ ¸å¿ƒåŠŸèƒ½ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚   (éœ€è¦ Bug ä¿®å¤åçš„ç¨³å®šåŸºç¡€)
    â”œâ”€â”€ Admin Dashboard
    â”‚       â””â”€â”€ éœ€è¦ RLS ç­–ç•¥
    â”œâ”€â”€ AI Review Assistant
    â”‚       â””â”€â”€ éœ€è¦ Admin Dashboard
    â””â”€â”€ ç®¡ç†å‘˜æƒé™ç³»ç»Ÿ
           â”‚
Phase 4: æ€§èƒ½å’ŒSEO â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚   (éœ€è¦æ ¸å¿ƒåŠŸèƒ½å®Œæˆåä¼˜åŒ–)
    â”œâ”€â”€ SEO ç»“æ„åŒ–æ•°æ®
    â”œâ”€â”€ WCAG å¯è®¿é—®æ€§
    â””â”€â”€ å›¾ç‰‡å’ŒBundleä¼˜åŒ–
           â”‚
Phase 5: æ¸¸æˆåŒ–ç³»ç»Ÿ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚   (éœ€è¦ç¨³å®šçš„æ ¸å¿ƒåŠŸèƒ½)
    â”œâ”€â”€ Success Score ç³»ç»Ÿ
    â”‚       â””â”€â”€ éœ€è¦æ•°æ®åº“è¡¨
    â”œâ”€â”€ ç­‰çº§å¾½ç« ä½“ç³»
    â”‚       â””â”€â”€ éœ€è¦ Success Score
    â””â”€â”€ 30å¤©å®½é™æœŸæœºåˆ¶
           â”‚
Phase 6: æµ‹è¯•å’Œæ”¶å°¾ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        (æœ€åéªŒè¯æ‰€æœ‰åŠŸèƒ½)
    â”œâ”€â”€ E2E æµ‹è¯•ä¿®å¤
    â”œâ”€â”€ å•å…ƒæµ‹è¯•è¦†ç›–
    â””â”€â”€ æœ€ç»ˆæ€§èƒ½ä¼˜åŒ–
```

### 1.2 ä¿®å¤é¡ºåºæ€»è§ˆ

| åºå· | Phase | ä»»åŠ¡ | ä¾èµ– | å·¥æ—¶ |
|------|-------|------|------|------|
| 1 | Phase 1 | Sentry é›†æˆ | æ—  | 4h |
| 2 | Phase 1 | PostHog é›†æˆ | æ—  | 4h |
| 3 | Phase 1 | Web Vitals ç›‘æ§ | Sentry | 2h |
| 4 | Phase 2 | ç™»å‡ºæµç¨‹ä¿®å¤ | ç›‘æ§ | 4h |
| 5 | Phase 2 | é€šçŸ¥é¢æ¿ä¿®å¤ | ç›‘æ§ | 8h |
| 6 | Phase 2 | è¡¨å•éªŒè¯ç»Ÿä¸€ | ç›‘æ§ | 8h |
| 7 | Phase 2 | ä»£ç åˆ†å‰²é…ç½® | æ—  | 4h |
| 8 | Phase 2 | Skeleton ç»„ä»¶ | ä»£ç åˆ†å‰² | 4h |
| 9 | Phase 3 | ç®¡ç†å‘˜ RLS ç­–ç•¥ | æ—  | 4h |
| 10 | Phase 3 | Admin Dashboard | RLS | 24h |
| 11 | Phase 3 | AI Review Assistant | Admin | 16h |
| 12 | Phase 4 | SEO ç»“æ„åŒ–æ•°æ® | æ—  | 8h |
| 13 | Phase 4 | WCAG å¯è®¿é—®æ€§ | æ—  | 16h |
| 14 | Phase 4 | å›¾ç‰‡ä¼˜åŒ– | æ—  | 8h |
| 15 | Phase 5 | Success Score æ•°æ®åº“ | æ—  | 4h |
| 16 | Phase 5 | Success Score ç®—æ³• | æ•°æ®åº“ | 8h |
| 17 | Phase 5 | ç­‰çº§å¾½ç« ä½“ç³» | Score | 16h |
| 18 | Phase 6 | E2E æµ‹è¯•ä¿®å¤ | å…¨éƒ¨ | 16h |
| 19 | Phase 6 | å•å…ƒæµ‹è¯•è¦†ç›– | å…¨éƒ¨ | 24h |
| 20 | Phase 6 | æœ€ç»ˆæ€§èƒ½ä¼˜åŒ– | å…¨éƒ¨ | 8h |

**æ€»å·¥æ—¶**: 186h â‰ˆ **5å‘¨å…¨èŒå¼€å‘**

---

## äºŒã€Phase 1: åŸºç¡€è®¾æ–½å’Œç›‘æ§ï¼ˆWeek 1ï¼‰

> **ç›®æ ‡**: å»ºç«‹å¯è§‚æµ‹æ€§åŸºç¡€ï¼Œä¸ºåç»­ä¿®å¤æä¾›ç›‘æ§æ”¯æŒ

### ä»»åŠ¡ 1.1: Sentry é”™è¯¯ç›‘æ§é›†æˆ

**æ­¥éª¤ 1: å®‰è£…ä¾èµ–**

```bash
cd /path/to/follow-ai
pnpm add @sentry/react
```

**æ­¥éª¤ 2: åˆ›å»º Sentry é…ç½®æ–‡ä»¶**

åˆ›å»ºæ–‡ä»¶ `src/lib/sentry.ts`:

```typescript
// src/lib/sentry.ts
import * as Sentry from '@sentry/react';

export function initSentry() {
  if (import.meta.env.VITE_SENTRY_DSN) {
    Sentry.init({
      dsn: import.meta.env.VITE_SENTRY_DSN,
      environment: import.meta.env.MODE,
      release: `follow-ai@${import.meta.env.VITE_APP_VERSION || '1.0.0'}`,
      
      integrations: [
        Sentry.browserTracingIntegration(),
        Sentry.replayIntegration({
          maskAllText: false,
          blockAllMedia: false,
        }),
      ],
      
      // ç”Ÿäº§ç¯å¢ƒé‡‡æ ·ç‡
      tracesSampleRate: import.meta.env.PROD ? 0.1 : 1.0,
      replaysSessionSampleRate: 0.1,
      replaysOnErrorSampleRate: 1.0,
      
      // è¿‡æ»¤å™ªéŸ³é”™è¯¯
      ignoreErrors: [
        'ResizeObserver loop limit exceeded',
        'ResizeObserver loop completed with undelivered notifications',
        'Network request failed',
        'Failed to fetch',
        /Loading chunk \d+ failed/,
        'AbortError',
        'ChunkLoadError',
      ],
      
      // ç§»é™¤æ•æ„Ÿä¿¡æ¯
      beforeSend(event) {
        if (event.user) {
          delete event.user.email;
          delete event.user.ip_address;
        }
        return event;
      },
    });
  }
}

// é”™è¯¯è¾¹ç•Œç»„ä»¶
export { ErrorBoundary } from '@sentry/react';

// æ‰‹åŠ¨æ•è·é”™è¯¯
export function captureError(error: Error, context?: Record<string, unknown>) {
  Sentry.captureException(error, { extra: context });
}

// æ•è·æ¶ˆæ¯
export function captureMessage(message: string, level: 'info' | 'warning' | 'error' = 'info') {
  Sentry.captureMessage(message, level);
}

// è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
export function setUser(user: { id: string; username?: string }) {
  Sentry.setUser({ id: user.id, username: user.username });
}

// æ¸…é™¤ç”¨æˆ·ä¸Šä¸‹æ–‡
export function clearUser() {
  Sentry.setUser(null);
}
```

**æ­¥éª¤ 3: åˆ›å»ºé”™è¯¯è¾¹ç•Œç»„ä»¶**

åˆ›å»ºæ–‡ä»¶ `src/components/ErrorFallback.tsx`:

```typescript
// src/components/ErrorFallback.tsx
import { useEffect } from 'react';

interface ErrorFallbackProps {
  error: Error;
  resetError: () => void;
}

export function ErrorFallback({ error, resetError }: ErrorFallbackProps) {
  useEffect(() => {
    // é”™è¯¯å·²è¢« Sentry è‡ªåŠ¨æ•è·
    console.error('Application error:', error);
  }, [error]);

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-900">
      <div className="max-w-md w-full bg-gray-800 rounded-lg p-8 text-center">
        <div className="text-6xl mb-4">ğŸ˜µ</div>
        <h1 className="text-2xl font-bold text-white mb-2">å‡ºé”™äº†</h1>
        <p className="text-gray-400 mb-6">
          åº”ç”¨ç¨‹åºé‡åˆ°äº†æ„å¤–é”™è¯¯ã€‚æˆ‘ä»¬å·²è®°å½•æ­¤é—®é¢˜å¹¶å°†å°½å¿«ä¿®å¤ã€‚
        </p>
        <div className="space-y-3">
          <button
            onClick={resetError}
            className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            é‡è¯•
          </button>
          <button
            onClick={() => window.location.href = '/'}
            className="w-full px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors"
          >
            è¿”å›é¦–é¡µ
          </button>
        </div>
        {import.meta.env.DEV && (
          <details className="mt-6 text-left">
            <summary className="text-gray-500 cursor-pointer">é”™è¯¯è¯¦æƒ…</summary>
            <pre className="mt-2 p-4 bg-gray-900 rounded text-red-400 text-xs overflow-auto">
              {error.message}
              {'\n\n'}
              {error.stack}
            </pre>
          </details>
        )}
      </div>
    </div>
  );
}
```

**æ­¥éª¤ 4: ä¿®æ”¹ main.tsx å…¥å£æ–‡ä»¶**

ä¿®æ”¹æ–‡ä»¶ `src/main.tsx`:

```typescript
// src/main.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import { ErrorBoundary } from '@sentry/react';
import App from './App';
import { initSentry } from './lib/sentry';
import { ErrorFallback } from './components/ErrorFallback';
import './index.css';

// åˆå§‹åŒ– Sentryï¼ˆå¿…é¡»åœ¨ React æ¸²æŸ“ä¹‹å‰ï¼‰
initSentry();

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <ErrorBoundary
      fallback={({ error, resetError }) => (
        <ErrorFallback error={error} resetError={resetError} />
      )}
    >
      <App />
    </ErrorBoundary>
  </React.StrictMode>
);
```

**æ­¥éª¤ 5: æ·»åŠ ç¯å¢ƒå˜é‡**

åœ¨ `.env` å’Œ `.env.production` ä¸­æ·»åŠ :

```env
VITE_SENTRY_DSN=your_sentry_dsn_here
VITE_APP_VERSION=1.0.0
```

**éªŒè¯æ–¹æ³•**:
```bash
# æ„å»ºå¹¶æ£€æŸ¥ Sentry æ˜¯å¦æ­£ç¡®åŠ è½½
pnpm build
# åœ¨æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥
# window.__SENTRY__ åº”è¯¥å­˜åœ¨
```

---

### ä»»åŠ¡ 1.2: PostHog äº§å“åˆ†æé›†æˆ

**æ­¥éª¤ 1: å®‰è£…ä¾èµ–**

```bash
pnpm add posthog-js
```

**æ­¥éª¤ 2: åˆ›å»º PostHog é…ç½®æ–‡ä»¶**

åˆ›å»ºæ–‡ä»¶ `src/lib/posthog.ts`:

```typescript
// src/lib/posthog.ts
import posthog from 'posthog-js';

let isInitialized = false;

export function initPostHog() {
  if (isInitialized || !import.meta.env.VITE_POSTHOG_KEY) {
    return;
  }

  posthog.init(import.meta.env.VITE_POSTHOG_KEY, {
    api_host: import.meta.env.VITE_POSTHOG_HOST || 'https://app.posthog.com',
    
    // è‡ªåŠ¨æ•è·é…ç½®
    autocapture: true,
    capture_pageview: true,
    capture_pageleave: true,
    
    // æŒä¹…åŒ–é…ç½®
    persistence: 'localStorage',
    
    // éšç§é…ç½®
    disable_session_recording: false,
    mask_all_text: false,
    mask_all_element_attributes: false,
    
    // Feature Flags å¯åŠ¨é…ç½®
    bootstrap: {
      featureFlags: {
        'new-dashboard': false,
        'ai-review-v2': false,
        'success-score': false,
      },
    },
    
    // åŠ è½½å®Œæˆå›è°ƒ
    loaded: (posthog) => {
      if (import.meta.env.DEV) {
        // å¼€å‘ç¯å¢ƒä¸‹å¯ç”¨è°ƒè¯•
        posthog.debug();
      }
    },
  });

  isInitialized = true;
}

// ç”¨æˆ·èº«ä»½è¯†åˆ«
export function identifyUser(userId: string, properties?: Record<string, unknown>) {
  if (!isInitialized) return;
  posthog.identify(userId, properties);
}

// é‡ç½®ç”¨æˆ·èº«ä»½
export function resetUser() {
  if (!isInitialized) return;
  posthog.reset();
}

// Feature Flag Hook
export function useFeatureFlag(flagKey: string): boolean | undefined {
  if (!isInitialized) return undefined;
  return posthog.isFeatureEnabled(flagKey);
}

// äº‹ä»¶è¿½è¸ª
export const analytics = {
  // é¡µé¢æµè§ˆ
  pageView: (pageName: string, properties?: Record<string, unknown>) => {
    posthog.capture('$pageview', { page_name: pageName, ...properties });
  },

  // ä»»åŠ¡ç›¸å…³äº‹ä»¶
  taskViewed: (taskId: string, taskType: string) => {
    posthog.capture('task_viewed', { task_id: taskId, task_type: taskType });
  },

  taskStarted: (taskId: string, taskType: string) => {
    posthog.capture('task_started', { task_id: taskId, task_type: taskType });
  },

  taskSubmitted: (taskId: string, taskType: string, duration?: number) => {
    posthog.capture('task_submitted', { 
      task_id: taskId, 
      task_type: taskType,
      duration_seconds: duration,
    });
  },

  taskApproved: (taskId: string, score: number, xpEarned: number) => {
    posthog.capture('task_approved', { 
      task_id: taskId, 
      quality_score: score,
      xp_earned: xpEarned,
    });
  },

  taskRejected: (taskId: string, reason: string) => {
    posthog.capture('task_rejected', { task_id: taskId, rejection_reason: reason });
  },

  // XP å’Œç­‰çº§äº‹ä»¶
  xpEarned: (amount: number, source: string) => {
    posthog.capture('xp_earned', { xp_amount: amount, source });
  },

  levelUp: (newLevel: number, previousLevel: number) => {
    posthog.capture('level_up', { new_level: newLevel, previous_level: previousLevel });
  },

  badgeEarned: (badgeId: string, badgeName: string) => {
    posthog.capture('badge_earned', { badge_id: badgeId, badge_name: badgeName });
  },

  // è®¤è¯äº‹ä»¶
  signUp: (method: string) => {
    posthog.capture('sign_up', { method });
  },

  signIn: (method: string) => {
    posthog.capture('sign_in', { method });
  },

  signOut: () => {
    posthog.capture('sign_out');
  },

  // æœç´¢å’Œç­›é€‰
  search: (query: string, resultsCount: number) => {
    posthog.capture('search', { query, results_count: resultsCount });
  },

  filterApplied: (filterType: string, filterValue: string) => {
    posthog.capture('filter_applied', { filter_type: filterType, filter_value: filterValue });
  },

  // é”™è¯¯è¿½è¸ª
  error: (errorType: string, errorMessage: string, context?: Record<string, unknown>) => {
    posthog.capture('error_occurred', { 
      error_type: errorType, 
      error_message: errorMessage,
      ...context,
    });
  },
};

// å¯¼å‡º posthog å®ä¾‹ä¾›é«˜çº§ç”¨æ³•
export { posthog };
```

**æ­¥éª¤ 3: åœ¨ main.tsx ä¸­åˆå§‹åŒ–**

ä¿®æ”¹ `src/main.tsx`:

```typescript
// src/main.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import { ErrorBoundary } from '@sentry/react';
import App from './App';
import { initSentry } from './lib/sentry';
import { initPostHog } from './lib/posthog';
import { ErrorFallback } from './components/ErrorFallback';
import './index.css';

// åˆå§‹åŒ–ç›‘æ§ï¼ˆå¿…é¡»åœ¨ React æ¸²æŸ“ä¹‹å‰ï¼‰
initSentry();
initPostHog();

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <ErrorBoundary
      fallback={({ error, resetError }) => (
        <ErrorFallback error={error} resetError={resetError} />
      )}
    >
      <App />
    </ErrorBoundary>
  </React.StrictMode>
);
```

**æ­¥éª¤ 4: æ·»åŠ ç¯å¢ƒå˜é‡**

```env
VITE_POSTHOG_KEY=your_posthog_key_here
VITE_POSTHOG_HOST=https://app.posthog.com
```

---

### ä»»åŠ¡ 1.3: Web Vitals ç›‘æ§

**æ­¥éª¤ 1: å®‰è£…ä¾èµ–**

```bash
pnpm add web-vitals
```

**æ­¥éª¤ 2: åˆ›å»º Web Vitals ç›‘æ§æ–‡ä»¶**

åˆ›å»ºæ–‡ä»¶ `src/lib/web-vitals.ts`:

```typescript
// src/lib/web-vitals.ts
import { onLCP, onINP, onCLS, onFCP, onTTFB, Metric } from 'web-vitals';
import * as Sentry from '@sentry/react';
import { posthog } from './posthog';

// æ€§èƒ½é˜ˆå€¼å®šä¹‰
const THRESHOLDS = {
  LCP: { good: 2500, poor: 4000 },
  INP: { good: 200, poor: 500 },
  CLS: { good: 0.1, poor: 0.25 },
  FCP: { good: 1800, poor: 3000 },
  TTFB: { good: 800, poor: 1800 },
};

// è·å–è¯„çº§
function getRating(name: string, value: number): 'good' | 'needs-improvement' | 'poor' {
  const threshold = THRESHOLDS[name as keyof typeof THRESHOLDS];
  if (!threshold) return 'good';
  
  if (value <= threshold.good) return 'good';
  if (value <= threshold.poor) return 'needs-improvement';
  return 'poor';
}

// å‘é€æŒ‡æ ‡åˆ°åˆ†ææœåŠ¡
function sendMetric(metric: Metric) {
  const rating = getRating(metric.name, metric.value);
  
  // å‘é€åˆ° PostHog
  posthog?.capture('web_vital', {
    metric_name: metric.name,
    metric_value: metric.value,
    metric_rating: rating,
    metric_delta: metric.delta,
    metric_id: metric.id,
    navigation_type: metric.navigationType,
  });

  // å¦‚æœæ€§èƒ½å·®ï¼Œå‘é€åˆ° Sentry ä½œä¸ºè­¦å‘Š
  if (rating === 'poor') {
    Sentry.captureMessage(`Performance regression: ${metric.name}`, {
      level: 'warning',
      tags: {
        web_vital: metric.name,
        rating: rating,
      },
      extra: {
        value: metric.value,
        threshold: THRESHOLDS[metric.name as keyof typeof THRESHOLDS],
        delta: metric.delta,
        id: metric.id,
      },
    });
  }

  // å¼€å‘ç¯å¢ƒä¸‹æ‰“å°åˆ°æ§åˆ¶å°
  if (import.meta.env.DEV) {
    console.log(`[Web Vital] ${metric.name}:`, {
      value: metric.value,
      rating,
      delta: metric.delta,
    });
  }
}

// åˆå§‹åŒ– Web Vitals ç›‘æ§
export function initWebVitals() {
  // æ ¸å¿ƒæŒ‡æ ‡
  onLCP(sendMetric);
  onINP(sendMetric);
  onCLS(sendMetric);
  
  // è¾…åŠ©æŒ‡æ ‡
  onFCP(sendMetric);
  onTTFB(sendMetric);
}

// React Hook ç”¨äºç»„ä»¶å†…ç›‘æ§
export function useWebVitals() {
  // åœ¨ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–
  if (typeof window !== 'undefined') {
    initWebVitals();
  }
}
```

**æ­¥éª¤ 3: åœ¨ main.tsx ä¸­åˆå§‹åŒ–**

ä¿®æ”¹ `src/main.tsx`:

```typescript
// src/main.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import { ErrorBoundary } from '@sentry/react';
import App from './App';
import { initSentry } from './lib/sentry';
import { initPostHog } from './lib/posthog';
import { initWebVitals } from './lib/web-vitals';
import { ErrorFallback } from './components/ErrorFallback';
import './index.css';

// åˆå§‹åŒ–ç›‘æ§ï¼ˆå¿…é¡»åœ¨ React æ¸²æŸ“ä¹‹å‰ï¼‰
initSentry();
initPostHog();

// Web Vitals åœ¨é¡µé¢åŠ è½½ååˆå§‹åŒ–
if (typeof window !== 'undefined') {
  window.addEventListener('load', () => {
    initWebVitals();
  });
}

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <ErrorBoundary
      fallback={({ error, resetError }) => (
        <ErrorFallback error={error} resetError={resetError} />
      )}
    >
      <App />
    </ErrorBoundary>
  </React.StrictMode>
);
```

**Phase 1 éªŒè¯æ¸…å•**:
- [ ] Sentry Dashboard èƒ½çœ‹åˆ°é”™è¯¯ä¸ŠæŠ¥
- [ ] PostHog Dashboard èƒ½çœ‹åˆ°äº‹ä»¶
- [ ] æ§åˆ¶å°èƒ½çœ‹åˆ° Web Vitals æ—¥å¿—
- [ ] æ„å»ºæˆåŠŸæ— é”™è¯¯

---

## ä¸‰ã€Phase 2: P0 Bug ä¿®å¤ï¼ˆWeek 2ï¼‰

> **ç›®æ ‡**: ä¿®å¤æ‰€æœ‰å½±å“ç”¨æˆ·ä½“éªŒçš„å…³é”® Bug

### ä»»åŠ¡ 2.1: ç™»å‡ºæµç¨‹ä¿®å¤

**é—®é¢˜åˆ†æ**:
- Supabase auth çŠ¶æ€æ¸…ç†ä¸å®Œæ•´
- localStorage æ®‹ç•™æ•°æ®
- React Query ç¼“å­˜æœªæ¸…ç†
- é¡µé¢æœªæ­£ç¡®é‡å®šå‘

**æ­¥éª¤ 1: ä¿®æ”¹ AuthContext**

ä¿®æ”¹æ–‡ä»¶ `src/contexts/AuthContext.tsx`:

```typescript
// src/contexts/AuthContext.tsx
import { createContext, useContext, useEffect, useState, useCallback, ReactNode } from 'react';
import { User, Session } from '@supabase/supabase-js';
import { supabase } from '@/lib/supabase';
import { useQueryClient } from '@tanstack/react-query';
import { useNavigate } from 'react-router-dom';
import { setUser as setSentryUser, clearUser as clearSentryUser } from '@/lib/sentry';
import { identifyUser, resetUser as resetPostHogUser, analytics } from '@/lib/posthog';

interface AuthContextType {
  user: User | null;
  session: Session | null;
  loading: boolean;
  signIn: (email: string, password: string) => Promise<{ error: Error | null }>;
  signUp: (email: string, password: string, username: string) => Promise<{ error: Error | null }>;
  signOut: () => Promise<void>;
  isAuthenticated: boolean;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);
  const queryClient = useQueryClient();
  const navigate = useNavigate();

  // åˆå§‹åŒ–è®¤è¯çŠ¶æ€
  useEffect(() => {
    // è·å–å½“å‰ä¼šè¯
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setUser(session?.user ?? null);
      
      // è®¾ç½®ç›‘æ§ç”¨æˆ·ä¸Šä¸‹æ–‡
      if (session?.user) {
        setSentryUser({ id: session.user.id });
        identifyUser(session.user.id, {
          email: session.user.email,
          created_at: session.user.created_at,
        });
      }
      
      setLoading(false);
    });

    // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        setSession(session);
        setUser(session?.user ?? null);

        if (event === 'SIGNED_IN' && session?.user) {
          setSentryUser({ id: session.user.id });
          identifyUser(session.user.id);
        }

        if (event === 'SIGNED_OUT') {
          clearSentryUser();
          resetPostHogUser();
        }
      }
    );

    return () => {
      subscription.unsubscribe();
    };
  }, []);

  // ç™»å½•
  const signIn = useCallback(async (email: string, password: string) => {
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        analytics.error('sign_in_failed', error.message);
        return { error };
      }

      analytics.signIn('email');
      return { error: null };
    } catch (error) {
      return { error: error as Error };
    }
  }, []);

  // æ³¨å†Œ
  const signUp = useCallback(async (email: string, password: string, username: string) => {
    try {
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: { username },
        },
      });

      if (error) {
        analytics.error('sign_up_failed', error.message);
        return { error };
      }

      analytics.signUp('email');
      return { error: null };
    } catch (error) {
      return { error: error as Error };
    }
  }, []);

  // ç™»å‡º - å®Œæ•´æ¸…ç†æµç¨‹
  const signOut = useCallback(async () => {
    try {
      // 1. è¿½è¸ªç™»å‡ºäº‹ä»¶
      analytics.signOut();

      // 2. è°ƒç”¨ Supabase ç™»å‡º
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('Supabase signOut error:', error);
      }

      // 3. æ¸…ç† React Query ç¼“å­˜
      queryClient.clear();

      // 4. æ¸…ç†æœ¬åœ°å­˜å‚¨
      localStorage.clear();
      sessionStorage.clear();

      // 5. æ¸…ç†ç›‘æ§ç”¨æˆ·ä¸Šä¸‹æ–‡
      clearSentryUser();
      resetPostHogUser();

      // 6. é‡ç½®æœ¬åœ°çŠ¶æ€
      setUser(null);
      setSession(null);

      // 7. é‡å®šå‘åˆ°é¦–é¡µ
      navigate('/', { replace: true });

    } catch (error) {
      console.error('SignOut error:', error);
      // å³ä½¿å‡ºé”™ä¹Ÿè¦æ¸…ç†çŠ¶æ€
      setUser(null);
      setSession(null);
      navigate('/', { replace: true });
    }
  }, [queryClient, navigate]);

  const value = {
    user,
    session,
    loading,
    signIn,
    signUp,
    signOut,
    isAuthenticated: !!user,
  };

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}
```

**æ­¥éª¤ 2: æ›´æ–° Navbar ç™»å‡ºæŒ‰é’®**

ä¿®æ”¹æ–‡ä»¶ `src/components/Navbar.tsx` ä¸­çš„ç™»å‡ºæŒ‰é’®:

```typescript
// åœ¨ Navbar ç»„ä»¶ä¸­æ‰¾åˆ°ç™»å‡ºæŒ‰é’®ï¼Œç¡®ä¿ä½¿ç”¨ signOut
import { useAuth } from '@/contexts/AuthContext';

// åœ¨ç»„ä»¶å†…
const { signOut, user } = useAuth();

// ç™»å‡ºæŒ‰é’®ï¼ˆæ¡Œé¢ç«¯ï¼‰
<button
  onClick={signOut}
  data-testid="logout-button"
  className="flex items-center gap-2 px-4 py-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg transition-colors"
>
  <LogOut className="w-4 h-4" />
  <span>ç™»å‡º</span>
</button>

// ç™»å‡ºæŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰
<button
  onClick={signOut}
  data-testid="logout-button-mobile"
  className="w-full flex items-center gap-3 px-4 py-3 text-red-400 hover:bg-red-500/10 rounded-lg transition-colors"
>
  <LogOut className="w-5 h-5" />
  <span>ç™»å‡º</span>
</button>
```

**éªŒè¯æ–¹æ³•**:
```bash
# è¿è¡Œ E2E æµ‹è¯•
PLAYWRIGHT_TEST_BASE_URL=https://www.follow-ai.com npx playwright test auth.spec.ts --grep "logout"
```

---

### ä»»åŠ¡ 2.2: é€šçŸ¥é¢æ¿ä¿®å¤

**é—®é¢˜åˆ†æ**:
- State ç®¡ç†ç«æ€æ¡ä»¶
- ç‚¹å‡»å¤–éƒ¨å…³é—­é€»è¾‘ä¸å®Œæ•´
- åŠ¨ç”»çŠ¶æ€ä¸åŒæ­¥

**æ­¥éª¤ 1: é‡å†™ NotificationCenter ç»„ä»¶**

ä¿®æ”¹æ–‡ä»¶ `src/components/NotificationCenter.tsx`:

```typescript
// src/components/NotificationCenter.tsx
import { useState, useRef, useEffect, useCallback } from 'react';
import { Bell, X, Check, Trash2 } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { supabase } from '@/lib/supabase';
import { useAuth } from '@/contexts/AuthContext';
import { formatDistanceToNow } from 'date-fns';
import { zhCN } from 'date-fns/locale';

interface Notification {
  id: string;
  title: string;
  message: string;
  type: 'info' | 'success' | 'warning' | 'error';
  read: boolean;
  created_at: string;
}

export function NotificationCenter() {
  const [isOpen, setIsOpen] = useState(false);
  const panelRef = useRef<HTMLDivElement>(null);
  const buttonRef = useRef<HTMLButtonElement>(null);
  const { user } = useAuth();
  const queryClient = useQueryClient();

  // è·å–é€šçŸ¥åˆ—è¡¨
  const { data: notifications = [], isLoading } = useQuery({
    queryKey: ['notifications', user?.id],
    queryFn: async () => {
      if (!user) return [];
      const { data, error } = await supabase
        .from('notifications')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false })
        .limit(20);
      
      if (error) throw error;
      return data as Notification[];
    },
    enabled: !!user,
    refetchInterval: 30000, // 30ç§’åˆ·æ–°ä¸€æ¬¡
  });

  // æœªè¯»æ•°é‡
  const unreadCount = notifications.filter(n => !n.read).length;

  // æ ‡è®°å·²è¯»
  const markAsReadMutation = useMutation({
    mutationFn: async (notificationId: string) => {
      const { error } = await supabase
        .from('notifications')
        .update({ read: true })
        .eq('id', notificationId);
      if (error) throw error;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['notifications'] });
    },
  });

  // æ ‡è®°å…¨éƒ¨å·²è¯»
  const markAllAsReadMutation = useMutation({
    mutationFn: async () => {
      if (!user) return;
      const { error } = await supabase
        .from('notifications')
        .update({ read: true })
        .eq('user_id', user.id)
        .eq('read', false);
      if (error) throw error;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['notifications'] });
    },
  });

  // åˆ é™¤é€šçŸ¥
  const deleteNotificationMutation = useMutation({
    mutationFn: async (notificationId: string) => {
      const { error } = await supabase
        .from('notifications')
        .delete()
        .eq('id', notificationId);
      if (error) throw error;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['notifications'] });
    },
  });

  // åˆ‡æ¢é¢æ¿
  const togglePanel = useCallback(() => {
    setIsOpen(prev => !prev);
  }, []);

  // å…³é—­é¢æ¿
  const closePanel = useCallback(() => {
    setIsOpen(false);
  }, []);

  // ç‚¹å‡»å¤–éƒ¨å…³é—­
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (
        panelRef.current &&
        buttonRef.current &&
        !panelRef.current.contains(event.target as Node) &&
        !buttonRef.current.contains(event.target as Node)
      ) {
        closePanel();
      }
    }

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
      return () => {
        document.removeEventListener('mousedown', handleClickOutside);
      };
    }
  }, [isOpen, closePanel]);

  // ESC é”®å…³é—­
  useEffect(() => {
    function handleEscape(event: KeyboardEvent) {
      if (event.key === 'Escape') {
        closePanel();
      }
    }

    if (isOpen) {
      document.addEventListener('keydown', handleEscape);
      return () => {
        document.removeEventListener('keydown', handleEscape);
      };
    }
  }, [isOpen, closePanel]);

  // è·å–é€šçŸ¥å›¾æ ‡é¢œè‰²
  const getTypeColor = (type: Notification['type']) => {
    switch (type) {
      case 'success': return 'text-green-400';
      case 'warning': return 'text-yellow-400';
      case 'error': return 'text-red-400';
      default: return 'text-blue-400';
    }
  };

  return (
    <div className="relative">
      {/* é€šçŸ¥æŒ‰é’® */}
      <button
        ref={buttonRef}
        onClick={togglePanel}
        data-testid="notifications-button"
        className="relative p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors"
        aria-label={`é€šçŸ¥ ${unreadCount > 0 ? `(${unreadCount} æ¡æœªè¯»)` : ''}`}
        aria-expanded={isOpen}
        aria-haspopup="true"
      >
        <Bell className="w-5 h-5" />
        {unreadCount > 0 && (
          <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">
            {unreadCount > 9 ? '9+' : unreadCount}
          </span>
        )}
      </button>

      {/* é€šçŸ¥é¢æ¿ */}
      <AnimatePresence>
        {isOpen && (
          <motion.div
            ref={panelRef}
            data-testid="notifications-panel"
            initial={{ opacity: 0, y: -10, scale: 0.95 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            exit={{ opacity: 0, y: -10, scale: 0.95 }}
            transition={{ duration: 0.15 }}
            className="absolute right-0 mt-2 w-80 sm:w-96 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl overflow-hidden z-50"
            role="dialog"
            aria-label="é€šçŸ¥é¢æ¿"
          >
            {/* å¤´éƒ¨ */}
            <div className="flex items-center justify-between px-4 py-3 border-b border-gray-700">
              <h3 className="font-semibold text-white">é€šçŸ¥</h3>
              <div className="flex items-center gap-2">
                {unreadCount > 0 && (
                  <button
                    onClick={() => markAllAsReadMutation.mutate()}
                    className="text-xs text-blue-400 hover:text-blue-300"
                    disabled={markAllAsReadMutation.isPending}
                  >
                    å…¨éƒ¨å·²è¯»
                  </button>
                )}
                <button
                  onClick={closePanel}
                  className="p-1 text-gray-400 hover:text-white rounded"
                  aria-label="å…³é—­é€šçŸ¥é¢æ¿"
                >
                  <X className="w-4 h-4" />
                </button>
              </div>
            </div>

            {/* é€šçŸ¥åˆ—è¡¨ */}
            <div className="max-h-96 overflow-y-auto">
              {isLoading ? (
                <div className="p-4 text-center text-gray-400">
                  åŠ è½½ä¸­...
                </div>
              ) : notifications.length === 0 ? (
                <div className="p-8 text-center text-gray-400">
                  <Bell className="w-12 h-12 mx-auto mb-3 opacity-50" />
                  <p>æš‚æ— é€šçŸ¥</p>
                </div>
              ) : (
                <ul className="divide-y divide-gray-700">
                  {notifications.map((notification) => (
                    <li
                      key={notification.id}
                      className={`px-4 py-3 hover:bg-gray-700/50 transition-colors ${
                        !notification.read ? 'bg-blue-500/5' : ''
                      }`}
                    >
                      <div className="flex items-start gap-3">
                        <div className={`mt-1 ${getTypeColor(notification.type)}`}>
                          <Bell className="w-4 h-4" />
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className={`text-sm font-medium ${
                            notification.read ? 'text-gray-300' : 'text-white'
                          }`}>
                            {notification.title}
                          </p>
                          <p className="text-xs text-gray-400 mt-1 line-clamp-2">
                            {notification.message}
                          </p>
                          <p className="text-xs text-gray-500 mt-1">
                            {formatDistanceToNow(new Date(notification.created_at), {
                              addSuffix: true,
                              locale: zhCN,
                            })}
                          </p>
                        </div>
                        <div className="flex items-center gap-1">
                          {!notification.read && (
                            <button
                              onClick={() => markAsReadMutation.mutate(notification.id)}
                              className="p-1 text-gray-400 hover:text-green-400 rounded"
                              title="æ ‡è®°å·²è¯»"
                            >
                              <Check className="w-4 h-4" />
                            </button>
                          )}
                          <button
                            onClick={() => deleteNotificationMutation.mutate(notification.id)}
                            className="p-1 text-gray-400 hover:text-red-400 rounded"
                            title="åˆ é™¤"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
```

---

### ä»»åŠ¡ 2.3: è¡¨å•éªŒè¯ç»Ÿä¸€ï¼ˆZod é›†æˆï¼‰

**æ­¥éª¤ 1: å®‰è£…ä¾èµ–**

```bash
pnpm add zod @hookform/resolvers react-hook-form
```

**æ­¥éª¤ 2: åˆ›å»ºéªŒè¯ Schema**

åˆ›å»ºæ–‡ä»¶ `src/lib/validations.ts`:

```typescript
// src/lib/validations.ts
import { z } from 'zod';

// é€šç”¨éªŒè¯è§„åˆ™
export const emailSchema = z
  .string()
  .min(1, 'è¯·è¾“å…¥é‚®ç®±')
  .email('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');

export const passwordSchema = z
  .string()
  .min(1, 'è¯·è¾“å…¥å¯†ç ')
  .min(8, 'å¯†ç è‡³å°‘8ä¸ªå­—ç¬¦')
  .regex(/[A-Z]/, 'å¯†ç éœ€è¦åŒ…å«è‡³å°‘ä¸€ä¸ªå¤§å†™å­—æ¯')
  .regex(/[a-z]/, 'å¯†ç éœ€è¦åŒ…å«è‡³å°‘ä¸€ä¸ªå°å†™å­—æ¯')
  .regex(/[0-9]/, 'å¯†ç éœ€è¦åŒ…å«è‡³å°‘ä¸€ä¸ªæ•°å­—');

export const usernameSchema = z
  .string()
  .min(1, 'è¯·è¾“å…¥ç”¨æˆ·å')
  .min(3, 'ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦')
  .max(20, 'ç”¨æˆ·åæœ€å¤š20ä¸ªå­—ç¬¦')
  .regex(/^[a-zA-Z0-9_]+$/, 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');

// ç™»å½•è¡¨å•
export const loginSchema = z.object({
  email: emailSchema,
  password: z.string().min(1, 'è¯·è¾“å…¥å¯†ç '),
});

export type LoginFormData = z.infer<typeof loginSchema>;

// æ³¨å†Œè¡¨å•
export const registerSchema = z.object({
  email: emailSchema,
  username: usernameSchema,
  password: passwordSchema,
  confirmPassword: z.string().min(1, 'è¯·ç¡®è®¤å¯†ç '),
}).refine((data) => data.password === data.confirmPassword, {
  message: 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´',
  path: ['confirmPassword'],
});

export type RegisterFormData = z.infer<typeof registerSchema>;

// ä»»åŠ¡æäº¤è¡¨å•
export const taskSubmissionSchema = z.object({
  title: z
    .string()
    .min(1, 'è¯·è¾“å…¥æ ‡é¢˜')
    .min(5, 'æ ‡é¢˜è‡³å°‘5ä¸ªå­—ç¬¦')
    .max(100, 'æ ‡é¢˜æœ€å¤š100ä¸ªå­—ç¬¦'),
  content: z
    .string()
    .min(1, 'è¯·è¾“å…¥å†…å®¹')
    .min(50, 'å†…å®¹è‡³å°‘50ä¸ªå­—ç¬¦')
    .max(10000, 'å†…å®¹æœ€å¤š10000ä¸ªå­—ç¬¦'),
  toolId: z.string().min(1, 'è¯·é€‰æ‹©AIå·¥å…·'),
  category: z.string().min(1, 'è¯·é€‰æ‹©ç±»åˆ«'),
  attachments: z.array(z.string()).optional(),
});

export type TaskSubmissionFormData = z.infer<typeof taskSubmissionSchema>;

// ä¸ªäººèµ„æ–™è¡¨å•
export const profileSchema = z.object({
  username: usernameSchema,
  bio: z.string().max(500, 'ç®€ä»‹æœ€å¤š500ä¸ªå­—ç¬¦').optional(),
  website: z.string().url('è¯·è¾“å…¥æœ‰æ•ˆçš„URL').optional().or(z.literal('')),
  twitter: z.string().max(50, 'Twitterç”¨æˆ·åæœ€å¤š50ä¸ªå­—ç¬¦').optional(),
  github: z.string().max(50, 'GitHubç”¨æˆ·åæœ€å¤š50ä¸ªå­—ç¬¦').optional(),
});

export type ProfileFormData = z.infer<typeof profileSchema>;
```

**æ­¥éª¤ 3: é‡å†™ AuthModal ç»„ä»¶**

ä¿®æ”¹æ–‡ä»¶ `src/components/AuthModal.tsx`:

```typescript
// src/components/AuthModal.tsx
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Mail, Lock, User, Eye, EyeOff, Loader2 } from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';
import { 
  loginSchema, 
  registerSchema, 
  LoginFormData, 
  RegisterFormData 
} from '@/lib/validations';

interface AuthModalProps {
  isOpen: boolean;
  onClose: () => void;
  initialMode?: 'login' | 'register';
}

export function AuthModal({ isOpen, onClose, initialMode = 'login' }: AuthModalProps) {
  const [mode, setMode] = useState<'login' | 'register'>(initialMode);
  const [showPassword, setShowPassword] = useState(false);
  const [serverError, setServerError] = useState<string | null>(null);
  const { signIn, signUp } = useAuth();

  // ç™»å½•è¡¨å•
  const loginForm = useForm<LoginFormData>({
    resolver: zodResolver(loginSchema),
    defaultValues: {
      email: '',
      password: '',
    },
  });

  // æ³¨å†Œè¡¨å•
  const registerForm = useForm<RegisterFormData>({
    resolver: zodResolver(registerSchema),
    defaultValues: {
      email: '',
      username: '',
      password: '',
      confirmPassword: '',
    },
  });

  const currentForm = mode === 'login' ? loginForm : registerForm;
  const isSubmitting = currentForm.formState.isSubmitting;

  // å¤„ç†ç™»å½•
  const handleLogin = async (data: LoginFormData) => {
    setServerError(null);
    const { error } = await signIn(data.email, data.password);
    if (error) {
      setServerError(error.message === 'Invalid login credentials' 
        ? 'é‚®ç®±æˆ–å¯†ç é”™è¯¯' 
        : error.message);
    } else {
      onClose();
      loginForm.reset();
    }
  };

  // å¤„ç†æ³¨å†Œ
  const handleRegister = async (data: RegisterFormData) => {
    setServerError(null);
    const { error } = await signUp(data.email, data.password, data.username);
    if (error) {
      if (error.message.includes('already registered')) {
        setServerError('è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ');
      } else {
        setServerError(error.message);
      }
    } else {
      onClose();
      registerForm.reset();
    }
  };

  // åˆ‡æ¢æ¨¡å¼
  const switchMode = () => {
    setMode(mode === 'login' ? 'register' : 'login');
    setServerError(null);
    loginForm.reset();
    registerForm.reset();
  };

  // å…³é—­æ¨¡æ€æ¡†
  const handleClose = () => {
    onClose();
    setServerError(null);
    loginForm.reset();
    registerForm.reset();
  };

  return (
    <AnimatePresence>
      {isOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          {/* èƒŒæ™¯é®ç½© */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={handleClose}
            className="absolute inset-0 bg-black/60 backdrop-blur-sm"
          />

          {/* æ¨¡æ€æ¡†å†…å®¹ */}
          <motion.div
            initial={{ opacity: 0, scale: 0.95, y: 20 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.95, y: 20 }}
            className="relative w-full max-w-md mx-4 bg-gray-800 rounded-2xl shadow-2xl overflow-hidden"
            data-testid="auth-modal"
          >
            {/* å…³é—­æŒ‰é’® */}
            <button
              onClick={handleClose}
              className="absolute top-4 right-4 p-2 text-gray-400 hover:text-white rounded-lg hover:bg-gray-700 transition-colors"
              aria-label="å…³é—­"
            >
              <X className="w-5 h-5" />
            </button>

            {/* å¤´éƒ¨ */}
            <div className="px-8 pt-8 pb-6">
              <h2 className="text-2xl font-bold text-white">
                {mode === 'login' ? 'æ¬¢è¿å›æ¥' : 'åˆ›å»ºè´¦æˆ·'}
              </h2>
              <p className="mt-2 text-gray-400">
                {mode === 'login' 
                  ? 'ç™»å½•ä»¥ç»§ç»­ä½¿ç”¨ Follow.ai' 
                  : 'æ³¨å†Œä»¥å¼€å§‹èµšå–æ”¶ç›Š'}
              </p>
            </div>

            {/* è¡¨å• */}
            <form
              onSubmit={mode === 'login' 
                ? loginForm.handleSubmit(handleLogin)
                : registerForm.handleSubmit(handleRegister)
              }
              className="px-8 pb-8 space-y-4"
            >
              {/* æœåŠ¡å™¨é”™è¯¯ */}
              {serverError && (
                <div 
                  data-testid="error-message"
                  className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm"
                >
                  {serverError}
                </div>
              )}

              {/* é‚®ç®±è¾“å…¥ */}
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1.5">
                  é‚®ç®±
                </label>
                <div className="relative">
                  <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                  <input
                    type="email"
                    {...(mode === 'login' 
                      ? loginForm.register('email')
                      : registerForm.register('email')
                    )}
                    data-testid="email-input"
                    placeholder="your@email.com"
                    className={`w-full pl-10 pr-4 py-3 bg-gray-700 border rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 transition-colors ${
                      currentForm.formState.errors.email
                        ? 'border-red-500 focus:ring-red-500'
                        : 'border-gray-600 focus:ring-blue-500'
                    }`}
                  />
                </div>
                {currentForm.formState.errors.email && (
                  <p data-testid="email-error" className="mt-1 text-sm text-red-400">
                    {currentForm.formState.errors.email.message}
                  </p>
                )}
              </div>

              {/* ç”¨æˆ·åè¾“å…¥ï¼ˆä»…æ³¨å†Œï¼‰ */}
              {mode === 'register' && (
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-1.5">
                    ç”¨æˆ·å
                  </label>
                  <div className="relative">
                    <User className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                    <input
                      type="text"
                      {...registerForm.register('username')}
                      data-testid="username-input"
                      placeholder="your_username"
                      className={`w-full pl-10 pr-4 py-3 bg-gray-700 border rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 transition-colors ${
                        registerForm.formState.errors.username
                          ? 'border-red-500 focus:ring-red-500'
                          : 'border-gray-600 focus:ring-blue-500'
                      }`}
                    />
                  </div>
                  {registerForm.formState.errors.username && (
                    <p data-testid="username-error" className="mt-1 text-sm text-red-400">
                      {registerForm.formState.errors.username.message}
                    </p>
                  )}
                </div>
              )}

              {/* å¯†ç è¾“å…¥ */}
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1.5">
                  å¯†ç 
                </label>
                <div className="relative">
                  <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                  <input
                    type={showPassword ? 'text' : 'password'}
                    {...(mode === 'login'
                      ? loginForm.register('password')
                      : registerForm.register('password')
                    )}
                    data-testid="password-input"
                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                    className={`w-full pl-10 pr-12 py-3 bg-gray-700 border rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 transition-colors ${
                      currentForm.formState.errors.password
                        ? 'border-red-500 focus:ring-red-500'
                        : 'border-gray-600 focus:ring-blue-500'
                    }`}
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white"
                  >
                    {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                  </button>
                </div>
                {currentForm.formState.errors.password && (
                  <p data-testid="password-error" className="mt-1 text-sm text-red-400">
                    {currentForm.formState.errors.password.message}
                  </p>
                )}
              </div>

              {/* ç¡®è®¤å¯†ç ï¼ˆä»…æ³¨å†Œï¼‰ */}
              {mode === 'register' && (
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-1.5">
                    ç¡®è®¤å¯†ç 
                  </label>
                  <div className="relative">
                    <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                    <input
                      type={showPassword ? 'text' : 'password'}
                      {...registerForm.register('confirmPassword')}
                      data-testid="confirm-password-input"
                      placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                      className={`w-full pl-10 pr-4 py-3 bg-gray-700 border rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 transition-colors ${
                        registerForm.formState.errors.confirmPassword
                          ? 'border-red-500 focus:ring-red-500'
                          : 'border-gray-600 focus:ring-blue-500'
                      }`}
                    />
                  </div>
                  {registerForm.formState.errors.confirmPassword && (
                    <p data-testid="confirm-password-error" className="mt-1 text-sm text-red-400">
                      {registerForm.formState.errors.confirmPassword.message}
                    </p>
                  )}
                </div>
              )}

              {/* æäº¤æŒ‰é’® */}
              <button
                type="submit"
                disabled={isSubmitting}
                data-testid="submit-button"
                className="w-full py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-600/50 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2"
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    <span>{mode === 'login' ? 'ç™»å½•ä¸­...' : 'æ³¨å†Œä¸­...'}</span>
                  </>
                ) : (
                  <span>{mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ'}</span>
                )}
              </button>

              {/* åˆ‡æ¢æ¨¡å¼ */}
              <p className="text-center text-gray-400">
                {mode === 'login' ? 'è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ' : 'å·²æœ‰è´¦æˆ·ï¼Ÿ'}
                <button
                  type="button"
                  onClick={switchMode}
                  className="ml-1 text-blue-400 hover:text-blue-300"
                >
                  {mode === 'login' ? 'ç«‹å³æ³¨å†Œ' : 'ç«‹å³ç™»å½•'}
                </button>
              </p>
            </form>
          </motion.div>
        </div>
      )}
    </AnimatePresence>
  );
}
```

---

### ä»»åŠ¡ 2.4: ä»£ç åˆ†å‰²é…ç½®

**æ­¥éª¤ 1: ä¿®æ”¹ Vite é…ç½®**

ä¿®æ”¹æ–‡ä»¶ `vite.config.ts`:

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react-swc';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  
  build: {
    target: 'esnext',
    minify: 'esbuild',
    sourcemap: false,
    
    rollupOptions: {
      output: {
        // æ‰‹åŠ¨åˆ†å‰²ä»£ç å—
        manualChunks: (id) => {
          // React æ ¸å¿ƒ
          if (id.includes('node_modules/react') || 
              id.includes('node_modules/react-dom') ||
              id.includes('node_modules/scheduler')) {
            return 'react-vendor';
          }
          
          // React Router
          if (id.includes('node_modules/react-router') ||
              id.includes('node_modules/@remix-run')) {
            return 'router-vendor';
          }
          
          // TanStack Query
          if (id.includes('node_modules/@tanstack')) {
            return 'tanstack-vendor';
          }
          
          // Supabase
          if (id.includes('node_modules/@supabase')) {
            return 'supabase-vendor';
          }
          
          // åŠ¨ç”»åº“
          if (id.includes('node_modules/framer-motion')) {
            return 'animation-vendor';
          }
          
          // å›¾è¡¨åº“
          if (id.includes('node_modules/recharts') ||
              id.includes('node_modules/d3')) {
            return 'charts-vendor';
          }
          
          // ç›‘æ§åº“
          if (id.includes('node_modules/@sentry') ||
              id.includes('node_modules/posthog')) {
            return 'monitoring-vendor';
          }
          
          // å…¶ä»–ç¬¬ä¸‰æ–¹åº“
          if (id.includes('node_modules')) {
            return 'vendor';
          }
        },
        
        // æ–‡ä»¶å‘½å
        chunkFileNames: 'assets/js/[name]-[hash].js',
        entryFileNames: 'assets/js/[name]-[hash].js',
        assetFileNames: 'assets/[ext]/[name]-[hash].[ext]',
      },
    },
    
    // å—å¤§å°è­¦å‘Šé˜ˆå€¼
    chunkSizeWarningLimit: 500,
  },
  
  // ä¼˜åŒ–ä¾èµ–é¢„æ„å»º
  optimizeDeps: {
    include: [
      'react',
      'react-dom',
      'react-router-dom',
      '@tanstack/react-query',
      '@supabase/supabase-js',
      'framer-motion',
    ],
  },
});
```

**æ­¥éª¤ 2: å®ç°è·¯ç”±çº§ä»£ç åˆ†å‰²**

ä¿®æ”¹æ–‡ä»¶ `src/App.tsx`:

```typescript
// src/App.tsx
import { Suspense, lazy } from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { AuthProvider } from '@/contexts/AuthContext';
import { Layout } from '@/components/Layout';
import { LoadingSpinner } from '@/components/LoadingSpinner';
import { ProtectedRoute } from '@/components/ProtectedRoute';

// æ‡’åŠ è½½é¡µé¢ç»„ä»¶
const Home = lazy(() => import('@/pages/Home'));
const Dashboard = lazy(() => import('@/pages/Dashboard'));
const Tasks = lazy(() => import('@/pages/Tasks'));
const TaskDetail = lazy(() => import('@/pages/TaskDetail'));
const Rankings = lazy(() => import('@/pages/Rankings'));
const Leaderboard = lazy(() => import('@/pages/Leaderboard'));
const Profile = lazy(() => import('@/pages/Profile'));
const Settings = lazy(() => import('@/pages/Settings'));
const Wallet = lazy(() => import('@/pages/Wallet'));
const Help = lazy(() => import('@/pages/Help'));
const NotFound = lazy(() => import('@/pages/NotFound'));

// Admin é¡µé¢ï¼ˆå•ç‹¬åˆ†å‰²ï¼‰
const AdminDashboard = lazy(() => import('@/pages/admin/Dashboard'));
const AdminUsers = lazy(() => import('@/pages/admin/Users'));
const AdminTasks = lazy(() => import('@/pages/admin/Tasks'));

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5åˆ†é’Ÿ
      gcTime: 1000 * 60 * 30, // 30åˆ†é’Ÿ
      retry: 1,
      refetchOnWindowFocus: false,
    },
  },
});

// é¡µé¢åŠ è½½éª¨æ¶å±
function PageLoader() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-900">
      <LoadingSpinner size="lg" />
    </div>
  );
}

export default function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <BrowserRouter>
        <AuthProvider>
          <Layout>
            <Suspense fallback={<PageLoader />}>
              <Routes>
                {/* å…¬å¼€é¡µé¢ */}
                <Route path="/" element={<Home />} />
                <Route path="/tasks" element={<Tasks />} />
                <Route path="/tasks/:id" element={<TaskDetail />} />
                <Route path="/rankings" element={<Rankings />} />
                <Route path="/leaderboard" element={<Leaderboard />} />
                <Route path="/help" element={<Help />} />
                
                {/* éœ€è¦è®¤è¯çš„é¡µé¢ */}
                <Route path="/dashboard" element={
                  <ProtectedRoute>
                    <Dashboard />
                  </ProtectedRoute>
                } />
                <Route path="/profile" element={
                  <ProtectedRoute>
                    <Profile />
                  </ProtectedRoute>
                } />
                <Route path="/settings" element={
                  <ProtectedRoute>
                    <Settings />
                  </ProtectedRoute>
                } />
                <Route path="/wallet" element={
                  <ProtectedRoute>
                    <Wallet />
                  </ProtectedRoute>
                } />
                
                {/* ç®¡ç†å‘˜é¡µé¢ */}
                <Route path="/admin" element={
                  <ProtectedRoute requireAdmin>
                    <AdminDashboard />
                  </ProtectedRoute>
                } />
                <Route path="/admin/users" element={
                  <ProtectedRoute requireAdmin>
                    <AdminUsers />
                  </ProtectedRoute>
                } />
                <Route path="/admin/tasks" element={
                  <ProtectedRoute requireAdmin>
                    <AdminTasks />
                  </ProtectedRoute>
                } />
                
                {/* 404 */}
                <Route path="*" element={<NotFound />} />
              </Routes>
            </Suspense>
          </Layout>
        </AuthProvider>
      </BrowserRouter>
    </QueryClientProvider>
  );
}
```

---

### ä»»åŠ¡ 2.5: Skeleton ç»„ä»¶å®ç°

åˆ›å»ºæ–‡ä»¶ `src/components/Skeleton.tsx`:

```typescript
// src/components/Skeleton.tsx
import { cn } from '@/lib/utils';

interface SkeletonProps {
  className?: string;
}

export function Skeleton({ className }: SkeletonProps) {
  return (
    <div
      className={cn(
        'animate-pulse rounded-md bg-gray-700/50',
        className
      )}
    />
  );
}

// å¡ç‰‡éª¨æ¶å±
export function CardSkeleton() {
  return (
    <div className="bg-gray-800 rounded-xl p-6 space-y-4">
      <Skeleton className="h-4 w-1/3" />
      <Skeleton className="h-8 w-1/2" />
      <Skeleton className="h-4 w-full" />
      <Skeleton className="h-4 w-2/3" />
    </div>
  );
}

// ä»»åŠ¡åˆ—è¡¨éª¨æ¶å±
export function TaskListSkeleton({ count = 5 }: { count?: number }) {
  return (
    <div className="space-y-4">
      {Array.from({ length: count }).map((_, i) => (
        <div key={i} className="bg-gray-800 rounded-xl p-4 flex items-center gap-4">
          <Skeleton className="w-12 h-12 rounded-lg" />
          <div className="flex-1 space-y-2">
            <Skeleton className="h-4 w-1/3" />
            <Skeleton className="h-3 w-1/2" />
          </div>
          <Skeleton className="h-8 w-20 rounded-lg" />
        </div>
      ))}
    </div>
  );
}

// ç”¨æˆ·èµ„æ–™éª¨æ¶å±
export function ProfileSkeleton() {
  return (
    <div className="bg-gray-800 rounded-xl p-6">
      <div className="flex items-center gap-4 mb-6">
        <Skeleton className="w-20 h-20 rounded-full" />
        <div className="space-y-2">
          <Skeleton className="h-6 w-32" />
          <Skeleton className="h-4 w-24" />
        </div>
      </div>
      <div className="grid grid-cols-3 gap-4">
        <div className="text-center">
          <Skeleton className="h-8 w-16 mx-auto mb-2" />
          <Skeleton className="h-4 w-12 mx-auto" />
        </div>
        <div className="text-center">
          <Skeleton className="h-8 w-16 mx-auto mb-2" />
          <Skeleton className="h-4 w-12 mx-auto" />
        </div>
        <div className="text-center">
          <Skeleton className="h-8 w-16 mx-auto mb-2" />
          <Skeleton className="h-4 w-12 mx-auto" />
        </div>
      </div>
    </div>
  );
}

// Dashboard ç»Ÿè®¡éª¨æ¶å±
export function DashboardStatsSkeleton() {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      {Array.from({ length: 4 }).map((_, i) => (
        <div key={i} className="bg-gray-800 rounded-xl p-6">
          <div className="flex items-center justify-between mb-4">
            <Skeleton className="h-4 w-20" />
            <Skeleton className="w-10 h-10 rounded-lg" />
          </div>
          <Skeleton className="h-8 w-24 mb-2" />
          <Skeleton className="h-3 w-16" />
        </div>
      ))}
    </div>
  );
}

// è¡¨æ ¼éª¨æ¶å±
export function TableSkeleton({ rows = 5, cols = 4 }: { rows?: number; cols?: number }) {
  return (
    <div className="bg-gray-800 rounded-xl overflow-hidden">
      {/* è¡¨å¤´ */}
      <div className="bg-gray-700/50 px-6 py-4 flex gap-4">
        {Array.from({ length: cols }).map((_, i) => (
          <Skeleton key={i} className="h-4 flex-1" />
        ))}
      </div>
      {/* è¡¨ä½“ */}
      <div className="divide-y divide-gray-700">
        {Array.from({ length: rows }).map((_, i) => (
          <div key={i} className="px-6 py-4 flex gap-4">
            {Array.from({ length: cols }).map((_, j) => (
              <Skeleton key={j} className="h-4 flex-1" />
            ))}
          </div>
        ))}
      </div>
    </div>
  );
}
```

åˆ›å»ºæ–‡ä»¶ `src/components/LoadingSpinner.tsx`:

```typescript
// src/components/LoadingSpinner.tsx
import { cn } from '@/lib/utils';

interface LoadingSpinnerProps {
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

export function LoadingSpinner({ size = 'md', className }: LoadingSpinnerProps) {
  const sizeClasses = {
    sm: 'w-4 h-4',
    md: 'w-8 h-8',
    lg: 'w-12 h-12',
  };

  return (
    <div className={cn('flex items-center justify-center', className)}>
      <div
        className={cn(
          'animate-spin rounded-full border-2 border-gray-600 border-t-blue-500',
          sizeClasses[size]
        )}
      />
    </div>
  );
}
```

**Phase 2 éªŒè¯æ¸…å•**:
- [ ] ç™»å‡ºåæ‰€æœ‰çŠ¶æ€æ¸…é™¤
- [ ] ç™»å‡ºåé‡å®šå‘åˆ°é¦–é¡µ
- [ ] é€šçŸ¥é¢æ¿æ­£å¸¸æ‰“å¼€/å…³é—­
- [ ] ç‚¹å‡»å¤–éƒ¨å…³é—­é€šçŸ¥é¢æ¿
- [ ] è¡¨å•éªŒè¯é”™è¯¯æ­£ç¡®æ˜¾ç¤º
- [ ] ä»£ç åˆ†å‰²å Bundle å¤§å° < 300KB
- [ ] é¡µé¢åŠ è½½æ˜¾ç¤ºéª¨æ¶å±

---


## å››ã€Phase 3: æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼ˆWeek 3-4ï¼‰

> **ç›®æ ‡**: å®ç° Admin Dashboard å’Œ AI Review Assistant

### ä»»åŠ¡ 3.1: ç®¡ç†å‘˜ RLS ç­–ç•¥

**æ­¥éª¤ 1: åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶**

åˆ›å»ºæ–‡ä»¶ `supabase/migrations/20260108_admin_roles.sql`:

```sql
-- ============================================
-- ç®¡ç†å‘˜è§’è‰²ç³»ç»Ÿ
-- ============================================

-- 1. æ·»åŠ ç®¡ç†å‘˜è§’è‰²å­—æ®µåˆ° profiles è¡¨
ALTER TABLE profiles 
ADD COLUMN IF NOT EXISTS role TEXT DEFAULT 'user' 
CHECK (role IN ('user', 'moderator', 'admin', 'super_admin'));

-- 2. åˆ›å»ºç®¡ç†å‘˜è§’è‰²ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_profiles_role ON profiles(role);

-- 3. åˆ›å»ºç®¡ç†å‘˜æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION is_admin()
RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1 FROM profiles 
    WHERE id = (SELECT auth.uid()) 
    AND role IN ('admin', 'super_admin')
  )
$$ LANGUAGE SQL SECURITY DEFINER STABLE;

-- 4. åˆ›å»ºç‰ˆä¸»æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION is_moderator()
RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1 FROM profiles 
    WHERE id = (SELECT auth.uid()) 
    AND role IN ('moderator', 'admin', 'super_admin')
  )
$$ LANGUAGE SQL SECURITY DEFINER STABLE;

-- 5. åˆ›å»ºç®¡ç†å‘˜å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS admin_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID REFERENCES auth.users(id) NOT NULL,
  action TEXT NOT NULL,
  target_type TEXT NOT NULL,
  target_id UUID,
  old_value JSONB,
  new_value JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 6. åˆ›å»ºå®¡è®¡æ—¥å¿—ç´¢å¼•
CREATE INDEX idx_audit_admin ON admin_audit_log(admin_id);
CREATE INDEX idx_audit_created ON admin_audit_log(created_at DESC);
CREATE INDEX idx_audit_target ON admin_audit_log(target_type, target_id);

-- 7. å¯ç”¨ RLS
ALTER TABLE admin_audit_log ENABLE ROW LEVEL SECURITY;

-- 8. å®¡è®¡æ—¥å¿— RLS ç­–ç•¥
CREATE POLICY "Admins can view audit logs" ON admin_audit_log
FOR SELECT TO authenticated
USING (is_admin());

CREATE POLICY "System can insert audit logs" ON admin_audit_log
FOR INSERT TO authenticated
WITH CHECK (is_admin());

-- 9. æ›´æ–° profiles è¡¨çš„ RLS ç­–ç•¥
DROP POLICY IF EXISTS "Users can view own profile" ON profiles;
DROP POLICY IF EXISTS "Users can update own profile" ON profiles;
DROP POLICY IF EXISTS "Admins can view all profiles" ON profiles;
DROP POLICY IF EXISTS "Admins can update all profiles" ON profiles;

CREATE POLICY "Users can view own profile" ON profiles
FOR SELECT TO authenticated
USING (id = (SELECT auth.uid()) OR is_admin());

CREATE POLICY "Users can update own profile" ON profiles
FOR UPDATE TO authenticated
USING (id = (SELECT auth.uid()))
WITH CHECK (id = (SELECT auth.uid()));

CREATE POLICY "Admins can update any profile" ON profiles
FOR UPDATE TO authenticated
USING (is_admin())
WITH CHECK (is_admin());

-- 10. åˆ›å»ºè®°å½•å®¡è®¡æ—¥å¿—çš„å‡½æ•°
CREATE OR REPLACE FUNCTION log_admin_action(
  p_action TEXT,
  p_target_type TEXT,
  p_target_id UUID DEFAULT NULL,
  p_old_value JSONB DEFAULT NULL,
  p_new_value JSONB DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
  v_log_id UUID;
BEGIN
  INSERT INTO admin_audit_log (admin_id, action, target_type, target_id, old_value, new_value)
  VALUES ((SELECT auth.uid()), p_action, p_target_type, p_target_id, p_old_value, p_new_value)
  RETURNING id INTO v_log_id;
  
  RETURN v_log_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 11. åˆ›å»ºè·å–ç®¡ç†å‘˜ç»Ÿè®¡çš„å‡½æ•°
CREATE OR REPLACE FUNCTION get_admin_stats()
RETURNS JSON AS $$
DECLARE
  result JSON;
BEGIN
  SELECT json_build_object(
    'total_users', (SELECT COUNT(*) FROM profiles),
    'active_users_today', (SELECT COUNT(*) FROM profiles WHERE last_seen_at > NOW() - INTERVAL '24 hours'),
    'new_users_today', (SELECT COUNT(*) FROM profiles WHERE created_at > NOW() - INTERVAL '24 hours'),
    'total_tasks', (SELECT COUNT(*) FROM tasks),
    'pending_tasks', (SELECT COUNT(*) FROM tasks WHERE status = 'pending'),
    'total_submissions', (SELECT COUNT(*) FROM submissions),
    'pending_submissions', (SELECT COUNT(*) FROM submissions WHERE status = 'pending'),
    'total_xp_distributed', (SELECT COALESCE(SUM(xp), 0) FROM xp_events)
  ) INTO result;
  
  RETURN result;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**æ­¥éª¤ 2: è¿è¡Œè¿ç§»**

```bash
# ä½¿ç”¨ Supabase CLI
supabase db push

# æˆ–è€…ç›´æ¥åœ¨ Supabase Dashboard çš„ SQL Editor ä¸­è¿è¡Œ
```

---

### ä»»åŠ¡ 3.2: Admin Dashboard å®ç°

**æ­¥éª¤ 1: åˆ›å»ºç›®å½•ç»“æ„**

```bash
mkdir -p src/pages/admin
mkdir -p src/components/admin
```

**æ­¥éª¤ 2: åˆ›å»º Admin Dashboard é¡µé¢**

åˆ›å»ºæ–‡ä»¶ `src/pages/admin/Dashboard.tsx`:

```typescript
// src/pages/admin/Dashboard.tsx
import { useQuery } from '@tanstack/react-query';
import { 
  Users, 
  FileText, 
  CheckCircle, 
  Clock, 
  TrendingUp,
  AlertTriangle,
  Activity
} from 'lucide-react';
import { supabase } from '@/lib/supabase';
import { DashboardStatsSkeleton } from '@/components/Skeleton';
import { StatsCard } from '@/components/admin/StatsCard';
import { RecentActivityList } from '@/components/admin/RecentActivityList';
import { PendingReviewsTable } from '@/components/admin/PendingReviewsTable';
import { UserGrowthChart } from '@/components/admin/UserGrowthChart';

interface AdminStats {
  total_users: number;
  active_users_today: number;
  new_users_today: number;
  total_tasks: number;
  pending_tasks: number;
  total_submissions: number;
  pending_submissions: number;
  total_xp_distributed: number;
}

export default function AdminDashboard() {
  // è·å–ç®¡ç†å‘˜ç»Ÿè®¡æ•°æ®
  const { data: stats, isLoading: statsLoading } = useQuery({
    queryKey: ['admin', 'stats'],
    queryFn: async () => {
      const { data, error } = await supabase.rpc('get_admin_stats');
      if (error) throw error;
      return data as AdminStats;
    },
    refetchInterval: 30000, // 30ç§’åˆ·æ–°
  });

  // è·å–å¾…å®¡æ ¸æäº¤
  const { data: pendingSubmissions = [], isLoading: submissionsLoading } = useQuery({
    queryKey: ['admin', 'pending-submissions'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('submissions')
        .select(`
          id,
          title,
          created_at,
          user:profiles(id, username, avatar_url),
          task:tasks(id, title, category)
        `)
        .eq('status', 'pending')
        .order('created_at', { ascending: true })
        .limit(10);
      
      if (error) throw error;
      return data;
    },
    refetchInterval: 60000, // 1åˆ†é’Ÿåˆ·æ–°
  });

  // è·å–æœ€è¿‘æ´»åŠ¨
  const { data: recentActivity = [], isLoading: activityLoading } = useQuery({
    queryKey: ['admin', 'recent-activity'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('admin_audit_log')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(20);
      
      if (error) throw error;
      return data;
    },
  });

  if (statsLoading) {
    return (
      <div className="p-6 space-y-6">
        <h1 className="text-2xl font-bold text-white">ç®¡ç†å‘˜ä»ªè¡¨æ¿</h1>
        <DashboardStatsSkeleton />
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-white">ç®¡ç†å‘˜ä»ªè¡¨æ¿</h1>
        <div className="flex items-center gap-2 text-sm text-gray-400">
          <Activity className="w-4 h-4" />
          <span>å®æ—¶æ›´æ–°ä¸­</span>
        </div>
      </div>

      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <StatsCard
          title="æ€»ç”¨æˆ·æ•°"
          value={stats?.total_users || 0}
          icon={<Users className="w-5 h-5" />}
          trend={stats?.new_users_today ? `+${stats.new_users_today} ä»Šæ—¥` : undefined}
          trendUp={true}
        />
        <StatsCard
          title="æ´»è·ƒç”¨æˆ·"
          value={stats?.active_users_today || 0}
          icon={<TrendingUp className="w-5 h-5" />}
          description="è¿‡å»24å°æ—¶"
        />
        <StatsCard
          title="å¾…å®¡æ ¸æäº¤"
          value={stats?.pending_submissions || 0}
          icon={<Clock className="w-5 h-5" />}
          highlight={stats?.pending_submissions > 10}
        />
        <StatsCard
          title="æ€»XPå‘æ”¾"
          value={stats?.total_xp_distributed || 0}
          icon={<CheckCircle className="w-5 h-5" />}
          format="number"
        />
      </div>

      {/* è­¦å‘Šæç¤º */}
      {stats?.pending_submissions > 20 && (
        <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-4 flex items-center gap-3">
          <AlertTriangle className="w-5 h-5 text-yellow-500" />
          <p className="text-yellow-500">
            æœ‰ {stats.pending_submissions} ä¸ªæäº¤å¾…å®¡æ ¸ï¼Œè¯·åŠæ—¶å¤„ç†ä»¥ä¿è¯ç”¨æˆ·ä½“éªŒã€‚
          </p>
        </div>
      )}

      {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* å¾…å®¡æ ¸åˆ—è¡¨ */}
        <div className="lg:col-span-2">
          <PendingReviewsTable 
            submissions={pendingSubmissions} 
            isLoading={submissionsLoading}
          />
        </div>

        {/* æœ€è¿‘æ´»åŠ¨ */}
        <div>
          <RecentActivityList 
            activities={recentActivity}
            isLoading={activityLoading}
          />
        </div>
      </div>

      {/* ç”¨æˆ·å¢é•¿å›¾è¡¨ */}
      <UserGrowthChart />
    </div>
  );
}
```

**æ­¥éª¤ 3: åˆ›å»º StatsCard ç»„ä»¶**

åˆ›å»ºæ–‡ä»¶ `src/components/admin/StatsCard.tsx`:

```typescript
// src/components/admin/StatsCard.tsx
import { ReactNode } from 'react';
import { TrendingUp, TrendingDown } from 'lucide-react';
import { cn } from '@/lib/utils';

interface StatsCardProps {
  title: string;
  value: number;
  icon: ReactNode;
  trend?: string;
  trendUp?: boolean;
  description?: string;
  highlight?: boolean;
  format?: 'number' | 'currency' | 'percent';
}

export function StatsCard({
  title,
  value,
  icon,
  trend,
  trendUp,
  description,
  highlight,
  format = 'number',
}: StatsCardProps) {
  const formatValue = (val: number) => {
    switch (format) {
      case 'currency':
        return `$${val.toLocaleString()}`;
      case 'percent':
        return `${val}%`;
      default:
        return val.toLocaleString();
    }
  };

  return (
    <div
      className={cn(
        'bg-gray-800 rounded-xl p-6 transition-all',
        highlight && 'ring-2 ring-yellow-500/50'
      )}
    >
      <div className="flex items-center justify-between mb-4">
        <span className="text-sm font-medium text-gray-400">{title}</span>
        <div className={cn(
          'p-2 rounded-lg',
          highlight ? 'bg-yellow-500/10 text-yellow-500' : 'bg-blue-500/10 text-blue-500'
        )}>
          {icon}
        </div>
      </div>
      
      <div className="space-y-1">
        <p className="text-3xl font-bold text-white">
          {formatValue(value)}
        </p>
        
        {trend && (
          <div className="flex items-center gap-1">
            {trendUp ? (
              <TrendingUp className="w-4 h-4 text-green-500" />
            ) : (
              <TrendingDown className="w-4 h-4 text-red-500" />
            )}
            <span className={cn(
              'text-sm',
              trendUp ? 'text-green-500' : 'text-red-500'
            )}>
              {trend}
            </span>
          </div>
        )}
        
        {description && (
          <p className="text-xs text-gray-500">{description}</p>
        )}
      </div>
    </div>
  );
}
```

**æ­¥éª¤ 4: åˆ›å»º PendingReviewsTable ç»„ä»¶**

åˆ›å»ºæ–‡ä»¶ `src/components/admin/PendingReviewsTable.tsx`:

```typescript
// src/components/admin/PendingReviewsTable.tsx
import { useState } from 'react';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { Check, X, Eye, Clock } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { zhCN } from 'date-fns/locale';
import { supabase } from '@/lib/supabase';
import { TableSkeleton } from '@/components/Skeleton';

interface Submission {
  id: string;
  title: string;
  created_at: string;
  user: {
    id: string;
    username: string;
    avatar_url: string;
  };
  task: {
    id: string;
    title: string;
    category: string;
  };
}

interface PendingReviewsTableProps {
  submissions: Submission[];
  isLoading: boolean;
}

export function PendingReviewsTable({ submissions, isLoading }: PendingReviewsTableProps) {
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const queryClient = useQueryClient();

  // å®¡æ‰¹æäº¤
  const approveMutation = useMutation({
    mutationFn: async ({ id, score }: { id: string; score: number }) => {
      const { error } = await supabase
        .from('submissions')
        .update({ 
          status: 'approved',
          quality_score: score,
          reviewed_at: new Date().toISOString(),
        })
        .eq('id', id);
      
      if (error) throw error;

      // è®°å½•å®¡è®¡æ—¥å¿—
      await supabase.rpc('log_admin_action', {
        p_action: 'approve_submission',
        p_target_type: 'submission',
        p_target_id: id,
        p_new_value: { status: 'approved', score },
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['admin'] });
    },
  });

  // æ‹’ç»æäº¤
  const rejectMutation = useMutation({
    mutationFn: async ({ id, reason }: { id: string; reason: string }) => {
      const { error } = await supabase
        .from('submissions')
        .update({ 
          status: 'rejected',
          rejection_reason: reason,
          reviewed_at: new Date().toISOString(),
        })
        .eq('id', id);
      
      if (error) throw error;

      // è®°å½•å®¡è®¡æ—¥å¿—
      await supabase.rpc('log_admin_action', {
        p_action: 'reject_submission',
        p_target_type: 'submission',
        p_target_id: id,
        p_new_value: { status: 'rejected', reason },
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['admin'] });
    },
  });

  if (isLoading) {
    return (
      <div className="bg-gray-800 rounded-xl p-6">
        <h2 className="text-lg font-semibold text-white mb-4">å¾…å®¡æ ¸æäº¤</h2>
        <TableSkeleton rows={5} cols={4} />
      </div>
    );
  }

  return (
    <div className="bg-gray-800 rounded-xl overflow-hidden">
      <div className="px-6 py-4 border-b border-gray-700">
        <h2 className="text-lg font-semibold text-white">å¾…å®¡æ ¸æäº¤</h2>
      </div>

      {submissions.length === 0 ? (
        <div className="p-8 text-center text-gray-400">
          <Check className="w-12 h-12 mx-auto mb-3 opacity-50" />
          <p>æ²¡æœ‰å¾…å®¡æ ¸çš„æäº¤</p>
        </div>
      ) : (
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-700/50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                  æäº¤
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                  ç”¨æˆ·
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                  ç­‰å¾…æ—¶é—´
                </th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">
                  æ“ä½œ
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-700">
              {submissions.map((submission) => (
                <tr key={submission.id} className="hover:bg-gray-700/30">
                  <td className="px-6 py-4">
                    <div>
                      <p className="text-sm font-medium text-white">
                        {submission.title}
                      </p>
                      <p className="text-xs text-gray-400">
                        {submission.task?.title} Â· {submission.task?.category}
                      </p>
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    <div className="flex items-center gap-2">
                      <img
                        src={submission.user?.avatar_url || '/default-avatar.png'}
                        alt=""
                        className="w-8 h-8 rounded-full"
                      />
                      <span className="text-sm text-gray-300">
                        {submission.user?.username}
                      </span>
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    <div className="flex items-center gap-1 text-sm text-gray-400">
                      <Clock className="w-4 h-4" />
                      {formatDistanceToNow(new Date(submission.created_at), {
                        addSuffix: true,
                        locale: zhCN,
                      })}
                    </div>
                  </td>
                  <td className="px-6 py-4 text-right">
                    <div className="flex items-center justify-end gap-2">
                      <button
                        onClick={() => setSelectedId(submission.id)}
                        className="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg"
                        title="æŸ¥çœ‹è¯¦æƒ…"
                      >
                        <Eye className="w-4 h-4" />
                      </button>
                      <button
                        onClick={() => approveMutation.mutate({ id: submission.id, score: 8 })}
                        disabled={approveMutation.isPending}
                        className="p-2 text-green-400 hover:text-green-300 hover:bg-green-500/10 rounded-lg"
                        title="æ‰¹å‡†"
                      >
                        <Check className="w-4 h-4" />
                      </button>
                      <button
                        onClick={() => rejectMutation.mutate({ id: submission.id, reason: 'ä¸ç¬¦åˆè¦æ±‚' })}
                        disabled={rejectMutation.isPending}
                        className="p-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg"
                        title="æ‹’ç»"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}
```

---

### ä»»åŠ¡ 3.3: AI Review Assistant å®ç°

**æ­¥éª¤ 1: åˆ›å»º Supabase Edge Function**

åˆ›å»ºæ–‡ä»¶ `supabase/functions/ai-review/index.ts`:

```typescript
// supabase/functions/ai-review/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

interface ReviewRequest {
  submissionId: string;
  content: string;
  taskType: string;
}

interface ReviewResult {
  status: 'approved' | 'needs_revision' | 'rejected';
  score: number;
  feedback: string;
  dimensions: {
    completeness: number;
    accuracy: number;
    formatting: number;
    creativity: number;
  };
  flagged: boolean;
  flagReason?: string;
}

serve(async (req) => {
  // å¤„ç† CORS é¢„æ£€è¯·æ±‚
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const { submissionId, content, taskType }: ReviewRequest = await req.json();

    // éªŒè¯è¾“å…¥
    if (!submissionId || !content) {
      return new Response(
        JSON.stringify({ error: 'Missing required fields' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const openaiApiKey = Deno.env.get('OPENAI_API_KEY');
    if (!openaiApiKey) {
      throw new Error('OPENAI_API_KEY not configured');
    }

    // Layer 1: å†…å®¹å®¡æ ¸ï¼ˆä½¿ç”¨å…è´¹çš„ Moderation APIï¼‰
    const moderationResponse = await fetch('https://api.openai.com/v1/moderations', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openaiApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'omni-moderation-latest',
        input: content,
      }),
    });

    const moderationData = await moderationResponse.json();
    
    if (moderationData.results?.[0]?.flagged) {
      const result: ReviewResult = {
        status: 'rejected',
        score: 0,
        feedback: 'å†…å®¹è¿åå¹³å°æ”¿ç­–ï¼Œè¯·ä¿®æ”¹åé‡æ–°æäº¤ã€‚',
        dimensions: { completeness: 0, accuracy: 0, formatting: 0, creativity: 0 },
        flagged: true,
        flagReason: Object.entries(moderationData.results[0].categories)
          .filter(([_, flagged]) => flagged)
          .map(([category]) => category)
          .join(', '),
      };

      return new Response(
        JSON.stringify(result),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Layer 2: è´¨é‡è¯„ä¼°ï¼ˆä½¿ç”¨ GPT-4o-mini é™ä½æˆæœ¬ï¼‰
    const qualityPrompt = `ä½ æ˜¯ä¸€ä¸ªAIä»»åŠ¡è´¨é‡å®¡æ ¸å‘˜ã€‚è¯·è¯„ä¼°ä»¥ä¸‹æäº¤å†…å®¹çš„è´¨é‡ã€‚

ä»»åŠ¡ç±»å‹: ${taskType}

æäº¤å†…å®¹:
${content.substring(0, 4000)}

è¯·ä»ä»¥ä¸‹å››ä¸ªç»´åº¦è¯„ä¼°ï¼ˆæ¯ä¸ªç»´åº¦1-10åˆ†ï¼‰ï¼š
1. å®Œæ•´æ€§ (completeness): å†…å®¹æ˜¯å¦å®Œæ•´ï¼Œæ˜¯å¦å›ç­”äº†æ‰€æœ‰è¦æ±‚
2. å‡†ç¡®æ€§ (accuracy): å†…å®¹æ˜¯å¦å‡†ç¡®ï¼Œæ˜¯å¦æœ‰äº‹å®é”™è¯¯
3. æ ¼å¼è§„èŒƒ (formatting): æ ¼å¼æ˜¯å¦æ¸…æ™°ï¼Œæ˜¯å¦æ˜“äºé˜…è¯»
4. åˆ›æ„æ€§ (creativity): æ˜¯å¦æœ‰ç‹¬ç‰¹è§è§£æˆ–åˆ›æ–°æ–¹æ³•

è¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼š
{
  "score": æ€»åˆ†(1-10),
  "feedback": "å…·ä½“åé¦ˆå»ºè®®ï¼ˆ100å­—ä»¥å†…ï¼‰",
  "dimensions": {
    "completeness": åˆ†æ•°,
    "accuracy": åˆ†æ•°,
    "formatting": åˆ†æ•°,
    "creativity": åˆ†æ•°
  }
}`;

    const qualityResponse = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openaiApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†…å®¹è´¨é‡å®¡æ ¸å‘˜ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¾“å‡ºã€‚' },
          { role: 'user', content: qualityPrompt },
        ],
        max_tokens: 500,
        temperature: 0.3,
      }),
    });

    const qualityData = await qualityResponse.json();
    const reviewContent = qualityData.choices?.[0]?.message?.content;

    // è§£æ AI å“åº”
    let review;
    try {
      // å°è¯•æå– JSON
      const jsonMatch = reviewContent.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        review = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error('No JSON found in response');
      }
    } catch (parseError) {
      // è§£æå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼
      review = {
        score: 7,
        feedback: 'å†…å®¹è´¨é‡è‰¯å¥½ï¼Œå·²é€šè¿‡å®¡æ ¸ã€‚',
        dimensions: {
          completeness: 7,
          accuracy: 7,
          formatting: 7,
          creativity: 7,
        },
      };
    }

    // ç¡®å®šå®¡æ ¸çŠ¶æ€
    let status: ReviewResult['status'];
    if (review.score >= 7) {
      status = 'approved';
    } else if (review.score >= 5) {
      status = 'needs_revision';
    } else {
      status = 'rejected';
    }

    const result: ReviewResult = {
      status,
      score: review.score,
      feedback: review.feedback,
      dimensions: review.dimensions,
      flagged: false,
    };

    // æ›´æ–°æ•°æ®åº“ä¸­çš„æäº¤è®°å½•
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    await supabase
      .from('submissions')
      .update({
        ai_review_score: review.score,
        ai_review_feedback: review.feedback,
        ai_review_dimensions: review.dimensions,
        ai_reviewed_at: new Date().toISOString(),
      })
      .eq('id', submissionId);

    return new Response(
      JSON.stringify(result),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );

  } catch (error) {
    console.error('AI Review error:', error);
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
```

**æ­¥éª¤ 2: éƒ¨ç½² Edge Function**

```bash
# éƒ¨ç½²åˆ° Supabase
supabase functions deploy ai-review

# è®¾ç½®ç¯å¢ƒå˜é‡
supabase secrets set OPENAI_API_KEY=your_openai_api_key
```

**æ­¥éª¤ 3: åˆ›å»ºå‰ç«¯è°ƒç”¨ Hook**

åˆ›å»ºæ–‡ä»¶ `src/hooks/useAIReview.ts`:

```typescript
// src/hooks/useAIReview.ts
import { useMutation } from '@tanstack/react-query';
import { supabase } from '@/lib/supabase';

interface AIReviewResult {
  status: 'approved' | 'needs_revision' | 'rejected';
  score: number;
  feedback: string;
  dimensions: {
    completeness: number;
    accuracy: number;
    formatting: number;
    creativity: number;
  };
  flagged: boolean;
  flagReason?: string;
}

export function useAIReview() {
  return useMutation({
    mutationFn: async ({
      submissionId,
      content,
      taskType,
    }: {
      submissionId: string;
      content: string;
      taskType: string;
    }): Promise<AIReviewResult> => {
      const { data, error } = await supabase.functions.invoke('ai-review', {
        body: { submissionId, content, taskType },
      });

      if (error) throw error;
      return data;
    },
  });
}
```

**Phase 3 éªŒè¯æ¸…å•**:
- [ ] ç®¡ç†å‘˜å¯ä»¥è®¿é—® /admin é¡µé¢
- [ ] æ™®é€šç”¨æˆ·è®¿é—® /admin è¢«é‡å®šå‘
- [ ] ç»Ÿè®¡æ•°æ®æ­£ç¡®æ˜¾ç¤º
- [ ] å¾…å®¡æ ¸åˆ—è¡¨æ­£å¸¸åŠ è½½
- [ ] æ‰¹å‡†/æ‹’ç»æ“ä½œæ­£å¸¸å·¥ä½œ
- [ ] AI Review è¿”å›æ­£ç¡®çš„è¯„åˆ†
- [ ] å®¡è®¡æ—¥å¿—æ­£ç¡®è®°å½•

---

## äº”ã€Phase 4: æ€§èƒ½å’ŒSEOä¼˜åŒ–ï¼ˆWeek 5-6ï¼‰

> **ç›®æ ‡**: ä¼˜åŒ–æ€§èƒ½æŒ‡æ ‡å’ŒSEO

### ä»»åŠ¡ 4.1: SEO ç»“æ„åŒ–æ•°æ®

**æ­¥éª¤ 1: åˆ›å»º Schema.org é…ç½®**

åˆ›å»ºæ–‡ä»¶ `src/lib/schema.ts`:

```typescript
// src/lib/schema.ts

// ç»„ç»‡ Schema
export const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  '@id': 'https://follow.ai/#organization',
  name: 'Follow.ai',
  url: 'https://follow.ai',
  logo: {
    '@type': 'ImageObject',
    url: 'https://follow.ai/logo.png',
    width: 512,
    height: 512,
  },
  description: 'The first AI tool review platform with mandatory real work verification.',
  sameAs: [
    'https://twitter.com/followai',
    'https://linkedin.com/company/followai',
  ],
  contactPoint: {
    '@type': 'ContactPoint',
    contactType: 'customer support',
    email: 'support@follow.ai',
  },
};

// ç½‘ç«™ Schema
export const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  '@id': 'https://follow.ai/#website',
  url: 'https://follow.ai',
  name: 'Follow.ai',
  description: 'AI Tool Review Platform',
  publisher: {
    '@id': 'https://follow.ai/#organization',
  },
  potentialAction: {
    '@type': 'SearchAction',
    target: {
      '@type': 'EntryPoint',
      urlTemplate: 'https://follow.ai/search?q={search_term_string}',
    },
    'query-input': 'required name=search_term_string',
  },
};

// FAQ Schema ç”Ÿæˆå™¨
export function generateFAQSchema(faqs: { question: string; answer: string }[]) {
  return {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    mainEntity: faqs.map((faq) => ({
      '@type': 'Question',
      name: faq.question,
      acceptedAnswer: {
        '@type': 'Answer',
        text: faq.answer,
      },
    })),
  };
}

// äº§å“ Schema ç”Ÿæˆå™¨ï¼ˆç”¨äº AI å·¥å…·ï¼‰
export function generateProductSchema(tool: {
  name: string;
  description: string;
  image: string;
  rating: number;
  reviewCount: number;
  category: string;
}) {
  return {
    '@context': 'https://schema.org',
    '@type': 'Product',
    name: tool.name,
    description: tool.description,
    image: tool.image,
    category: tool.category,
    aggregateRating: {
      '@type': 'AggregateRating',
      ratingValue: tool.rating,
      reviewCount: tool.reviewCount,
      bestRating: 5,
      worstRating: 1,
    },
  };
}

// è¯„è®º Schema ç”Ÿæˆå™¨
export function generateReviewSchema(review: {
  author: string;
  datePublished: string;
  reviewBody: string;
  rating: number;
  itemReviewed: {
    name: string;
    type: string;
  };
}) {
  return {
    '@context': 'https://schema.org',
    '@type': 'Review',
    author: {
      '@type': 'Person',
      name: review.author,
    },
    datePublished: review.datePublished,
    reviewBody: review.reviewBody,
    reviewRating: {
      '@type': 'Rating',
      ratingValue: review.rating,
      bestRating: 5,
      worstRating: 1,
    },
    itemReviewed: {
      '@type': review.itemReviewed.type,
      name: review.itemReviewed.name,
    },
  };
}

// é¢åŒ…å±‘ Schema ç”Ÿæˆå™¨
export function generateBreadcrumbSchema(items: { name: string; url: string }[]) {
  return {
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: items.map((item, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: item.name,
      item: item.url,
    })),
  };
}
```

**æ­¥éª¤ 2: åˆ›å»º SEO ç»„ä»¶**

åˆ›å»ºæ–‡ä»¶ `src/components/SEO.tsx`:

```typescript
// src/components/SEO.tsx
import { Helmet } from 'react-helmet-async';
import { organizationSchema, websiteSchema } from '@/lib/schema';

interface SEOProps {
  title?: string;
  description?: string;
  image?: string;
  url?: string;
  type?: 'website' | 'article' | 'product';
  schema?: object | object[];
  noindex?: boolean;
}

const DEFAULT_TITLE = 'Follow.ai - Where AI Tools Show Their Real Work';
const DEFAULT_DESCRIPTION = 'The first AI tool review platform with mandatory real work verification. No fake reviews. No upvote farms. Just real outputs from real users.';
const DEFAULT_IMAGE = 'https://follow.ai/og-image.png';
const SITE_URL = 'https://follow.ai';

export function SEO({
  title,
  description = DEFAULT_DESCRIPTION,
  image = DEFAULT_IMAGE,
  url,
  type = 'website',
  schema,
  noindex = false,
}: SEOProps) {
  const fullTitle = title ? `${title} | Follow.ai` : DEFAULT_TITLE;
  const fullUrl = url ? `${SITE_URL}${url}` : SITE_URL;

  // åˆå¹¶ Schema
  const schemas = [
    organizationSchema,
    websiteSchema,
    ...(Array.isArray(schema) ? schema : schema ? [schema] : []),
  ];

  return (
    <Helmet>
      {/* åŸºç¡€ Meta */}
      <title>{fullTitle}</title>
      <meta name="description" content={description} />
      <link rel="canonical" href={fullUrl} />
      
      {noindex && <meta name="robots" content="noindex, nofollow" />}

      {/* Open Graph */}
      <meta property="og:type" content={type} />
      <meta property="og:title" content={fullTitle} />
      <meta property="og:description" content={description} />
      <meta property="og:image" content={image} />
      <meta property="og:url" content={fullUrl} />
      <meta property="og:site_name" content="Follow.ai" />

      {/* Twitter Card */}
      <meta name="twitter:card" content="summary_large_image" />
      <meta name="twitter:title" content={fullTitle} />
      <meta name="twitter:description" content={description} />
      <meta name="twitter:image" content={image} />
      <meta name="twitter:site" content="@followai" />

      {/* ç»“æ„åŒ–æ•°æ® */}
      {schemas.map((s, i) => (
        <script key={i} type="application/ld+json">
          {JSON.stringify(s)}
        </script>
      ))}
    </Helmet>
  );
}
```

**æ­¥éª¤ 3: å®‰è£…ä¾èµ–å¹¶é…ç½®**

```bash
pnpm add react-helmet-async
```

ä¿®æ”¹ `src/main.tsx`:

```typescript
import { HelmetProvider } from 'react-helmet-async';

// åŒ…è£… App
<HelmetProvider>
  <App />
</HelmetProvider>
```

**æ­¥éª¤ 4: åˆ›å»º Sitemap ç”Ÿæˆè„šæœ¬**

åˆ›å»ºæ–‡ä»¶ `scripts/generate-sitemap.ts`:

```typescript
// scripts/generate-sitemap.ts
import { writeFileSync } from 'fs';
import { createClient } from '@supabase/supabase-js';

const SITE_URL = 'https://follow.ai';

async function generateSitemap() {
  const supabase = createClient(
    process.env.SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );

  // é™æ€é¡µé¢
  const staticPages = [
    { url: '/', priority: 1.0, changefreq: 'daily' },
    { url: '/tasks', priority: 0.9, changefreq: 'daily' },
    { url: '/rankings', priority: 0.8, changefreq: 'daily' },
    { url: '/leaderboard', priority: 0.8, changefreq: 'daily' },
    { url: '/help', priority: 0.5, changefreq: 'monthly' },
  ];

  // è·å–æ‰€æœ‰ä»»åŠ¡
  const { data: tasks } = await supabase
    .from('tasks')
    .select('id, updated_at')
    .eq('status', 'active');

  // è·å–æ‰€æœ‰å·¥å…·
  const { data: tools } = await supabase
    .from('tools')
    .select('id, updated_at');

  // ç”Ÿæˆ XML
  const xml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  ${staticPages.map(page => `
  <url>
    <loc>${SITE_URL}${page.url}</loc>
    <changefreq>${page.changefreq}</changefreq>
    <priority>${page.priority}</priority>
  </url>`).join('')}
  ${(tasks || []).map(task => `
  <url>
    <loc>${SITE_URL}/tasks/${task.id}</loc>
    <lastmod>${new Date(task.updated_at).toISOString()}</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.7</priority>
  </url>`).join('')}
  ${(tools || []).map(tool => `
  <url>
    <loc>${SITE_URL}/tools/${tool.id}</loc>
    <lastmod>${new Date(tool.updated_at).toISOString()}</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.7</priority>
  </url>`).join('')}
</urlset>`;

  writeFileSync('public/sitemap.xml', xml);
  console.log('Sitemap generated successfully!');
}

generateSitemap();
```

---

### ä»»åŠ¡ 4.2: WCAG å¯è®¿é—®æ€§ä¼˜åŒ–

**æ­¥éª¤ 1: åˆ›å»ºå¯è®¿é—®æ€§å·¥å…·å‡½æ•°**

åˆ›å»ºæ–‡ä»¶ `src/lib/a11y.ts`:

```typescript
// src/lib/a11y.ts

// ç„¦ç‚¹ç®¡ç†
export function trapFocus(element: HTMLElement) {
  const focusableElements = element.querySelectorAll(
    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
  );
  const firstElement = focusableElements[0] as HTMLElement;
  const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement;

  function handleKeyDown(e: KeyboardEvent) {
    if (e.key !== 'Tab') return;

    if (e.shiftKey) {
      if (document.activeElement === firstElement) {
        lastElement.focus();
        e.preventDefault();
      }
    } else {
      if (document.activeElement === lastElement) {
        firstElement.focus();
        e.preventDefault();
      }
    }
  }

  element.addEventListener('keydown', handleKeyDown);
  firstElement?.focus();

  return () => {
    element.removeEventListener('keydown', handleKeyDown);
  };
}

// å±å¹•é˜…è¯»å™¨å…¬å‘Š
export function announce(message: string, priority: 'polite' | 'assertive' = 'polite') {
  const announcer = document.createElement('div');
  announcer.setAttribute('aria-live', priority);
  announcer.setAttribute('aria-atomic', 'true');
  announcer.setAttribute('class', 'sr-only');
  document.body.appendChild(announcer);

  setTimeout(() => {
    announcer.textContent = message;
  }, 100);

  setTimeout(() => {
    document.body.removeChild(announcer);
  }, 1000);
}

// è·³è¿‡å¯¼èˆªé“¾æ¥
export function SkipLink() {
  return (
    <a
      href="#main-content"
      className="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-blue-600 focus:text-white focus:rounded-lg"
    >
      è·³è¿‡å¯¼èˆª
    </a>
  );
}
```

**æ­¥éª¤ 2: åˆ›å»ºå¯è®¿é—®æ€§æŒ‰é’®ç»„ä»¶**

åˆ›å»ºæ–‡ä»¶ `src/components/ui/AccessibleButton.tsx`:

```typescript
// src/components/ui/AccessibleButton.tsx
import { forwardRef, ButtonHTMLAttributes, ReactNode } from 'react';
import { Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface AccessibleButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'danger' | 'ghost';
  size?: 'sm' | 'md' | 'lg';
  loading?: boolean;
  icon?: ReactNode;
  children: ReactNode;
}

export const AccessibleButton = forwardRef<HTMLButtonElement, AccessibleButtonProps>(
  ({ 
    variant = 'primary', 
    size = 'md', 
    loading, 
    disabled, 
    icon,
    children, 
    className,
    ...props 
  }, ref) => {
    const baseStyles = cn(
      // WCAG 2.2: æœ€å°è§¦æ‘¸ç›®æ ‡ 44x44px
      'inline-flex items-center justify-center gap-2 font-medium rounded-lg transition-all',
      // ç„¦ç‚¹æŒ‡ç¤ºå™¨ï¼š2px ä»¥ä¸Šå®çº¿è½®å»“
      'focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900',
      // ç¦ç”¨çŠ¶æ€
      (disabled || loading) && 'opacity-50 cursor-not-allowed',
    );

    const variantStyles = {
      primary: 'bg-blue-600 text-white hover:bg-blue-700 focus-visible:ring-blue-500',
      secondary: 'bg-gray-700 text-white hover:bg-gray-600 focus-visible:ring-gray-500',
      danger: 'bg-red-600 text-white hover:bg-red-700 focus-visible:ring-red-500',
      ghost: 'bg-transparent text-gray-300 hover:bg-gray-700 hover:text-white focus-visible:ring-gray-500',
    };

    const sizeStyles = {
      sm: 'min-h-[36px] min-w-[36px] px-3 py-1.5 text-sm',
      md: 'min-h-[44px] min-w-[44px] px-4 py-2 text-base',
      lg: 'min-h-[52px] min-w-[52px] px-6 py-3 text-lg',
    };

    return (
      <button
        ref={ref}
        disabled={disabled || loading}
        aria-busy={loading}
        aria-disabled={disabled || loading}
        className={cn(baseStyles, variantStyles[variant], sizeStyles[size], className)}
        {...props}
      >
        {loading ? (
          <>
            <Loader2 className="w-4 h-4 animate-spin" aria-hidden="true" />
            <span>å¤„ç†ä¸­...</span>
          </>
        ) : (
          <>
            {icon && <span aria-hidden="true">{icon}</span>}
            {children}
          </>
        )}
      </button>
    );
  }
);

AccessibleButton.displayName = 'AccessibleButton';
```

**æ­¥éª¤ 3: æ·»åŠ å…¨å±€ CSS æ ·å¼**

åœ¨ `src/index.css` ä¸­æ·»åŠ :

```css
/* å±å¹•é˜…è¯»å™¨ä¸“ç”¨æ ·å¼ */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

.not-sr-only {
  position: static;
  width: auto;
  height: auto;
  padding: 0;
  margin: 0;
  overflow: visible;
  clip: auto;
  white-space: normal;
}

/* ç„¦ç‚¹æ ·å¼å¢å¼º */
:focus-visible {
  outline: 2px solid #3b82f6;
  outline-offset: 2px;
}

/* å‡å°‘åŠ¨ç”»ï¼ˆç”¨æˆ·åå¥½ï¼‰ */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* é«˜å¯¹æ¯”åº¦æ¨¡å¼ */
@media (prefers-contrast: high) {
  :root {
    --color-text: #ffffff;
    --color-bg: #000000;
    --color-border: #ffffff;
  }
}
```

**Phase 4 éªŒè¯æ¸…å•**:
- [ ] æ‰€æœ‰é¡µé¢æœ‰æ­£ç¡®çš„ title å’Œ description
- [ ] Schema.org ç»“æ„åŒ–æ•°æ®æ­£ç¡®
- [ ] sitemap.xml ç”ŸæˆæˆåŠŸ
- [ ] æ‰€æœ‰æŒ‰é’® â‰¥ 44x44px
- [ ] ç„¦ç‚¹æŒ‡ç¤ºå™¨æ¸…æ™°å¯è§
- [ ] é”®ç›˜å¯ä»¥å®Œå…¨å¯¼èˆª
- [ ] å±å¹•é˜…è¯»å™¨å¯ä»¥æ­£ç¡®è¯»å–

---


## å…­ã€Phase 5: æ¸¸æˆåŒ–ç³»ç»Ÿï¼ˆWeek 7-8ï¼‰

> **ç›®æ ‡**: å®ç° Success Score å’Œç­‰çº§å¾½ç« ä½“ç³»

### ä»»åŠ¡ 5.1: Success Score æ•°æ®åº“è®¾è®¡

**æ­¥éª¤ 1: åˆ›å»ºæ•°æ®åº“è¿ç§»**

åˆ›å»ºæ–‡ä»¶ `supabase/migrations/20260108_success_score.sql`:

```sql
-- ============================================
-- Success Score æ¸¸æˆåŒ–ç³»ç»Ÿ
-- ============================================

-- 1. åˆ›å»º Success Score è¡¨
CREATE TABLE IF NOT EXISTS success_scores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- æ ¸å¿ƒåˆ†æ•°
  total_score INTEGER DEFAULT 0,
  current_streak INTEGER DEFAULT 0,
  longest_streak INTEGER DEFAULT 0,
  
  -- å„ç»´åº¦åˆ†æ•°
  quality_score INTEGER DEFAULT 0,      -- è´¨é‡åˆ† (0-100)
  consistency_score INTEGER DEFAULT 0,  -- ä¸€è‡´æ€§åˆ† (0-100)
  speed_score INTEGER DEFAULT 0,        -- é€Ÿåº¦åˆ† (0-100)
  diversity_score INTEGER DEFAULT 0,    -- å¤šæ ·æ€§åˆ† (0-100)
  
  -- ç»Ÿè®¡æ•°æ®
  total_submissions INTEGER DEFAULT 0,
  approved_submissions INTEGER DEFAULT 0,
  rejected_submissions INTEGER DEFAULT 0,
  total_xp_earned INTEGER DEFAULT 0,
  
  -- 30å¤©å®½é™æœŸ
  grace_period_start TIMESTAMPTZ,
  grace_period_reason TEXT,
  
  -- æ—¶é—´æˆ³
  last_activity_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(user_id)
);

-- 2. åˆ›å»ºç´¢å¼•
CREATE INDEX idx_success_scores_user ON success_scores(user_id);
CREATE INDEX idx_success_scores_total ON success_scores(total_score DESC);
CREATE INDEX idx_success_scores_streak ON success_scores(current_streak DESC);

-- 3. åˆ›å»ºç­‰çº§è¡¨
CREATE TABLE IF NOT EXISTS user_levels (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  level INTEGER DEFAULT 1,
  xp_current INTEGER DEFAULT 0,
  xp_to_next_level INTEGER DEFAULT 100,
  title TEXT DEFAULT 'Novice',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(user_id)
);

-- 4. åˆ›å»ºå¾½ç« è¡¨
CREATE TABLE IF NOT EXISTS badges (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT NOT NULL,
  icon TEXT NOT NULL,
  category TEXT NOT NULL CHECK (category IN ('achievement', 'streak', 'quality', 'special')),
  requirement_type TEXT NOT NULL,
  requirement_value INTEGER NOT NULL,
  xp_reward INTEGER DEFAULT 0,
  rarity TEXT DEFAULT 'common' CHECK (rarity IN ('common', 'uncommon', 'rare', 'epic', 'legendary')),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 5. åˆ›å»ºç”¨æˆ·å¾½ç« å…³è”è¡¨
CREATE TABLE IF NOT EXISTS user_badges (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  badge_id UUID REFERENCES badges(id) ON DELETE CASCADE NOT NULL,
  earned_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(user_id, badge_id)
);

-- 6. åˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_badges_user ON user_badges(user_id);
CREATE INDEX idx_user_badges_badge ON user_badges(badge_id);

-- 7. å¯ç”¨ RLS
ALTER TABLE success_scores ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_levels ENABLE ROW LEVEL SECURITY;
ALTER TABLE badges ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_badges ENABLE ROW LEVEL SECURITY;

-- 8. RLS ç­–ç•¥
CREATE POLICY "Users can view own success score" ON success_scores
FOR SELECT TO authenticated
USING (user_id = (SELECT auth.uid()) OR is_admin());

CREATE POLICY "System can update success scores" ON success_scores
FOR ALL TO authenticated
USING (is_admin())
WITH CHECK (is_admin());

CREATE POLICY "Users can view own level" ON user_levels
FOR SELECT TO authenticated
USING (user_id = (SELECT auth.uid()) OR is_admin());

CREATE POLICY "Anyone can view badges" ON badges
FOR SELECT TO authenticated
USING (true);

CREATE POLICY "Users can view own badges" ON user_badges
FOR SELECT TO authenticated
USING (user_id = (SELECT auth.uid()) OR is_admin());

-- 9. æ’å…¥é»˜è®¤å¾½ç« 
INSERT INTO badges (name, description, icon, category, requirement_type, requirement_value, xp_reward, rarity) VALUES
-- æˆå°±å¾½ç« 
('First Steps', 'å®Œæˆç¬¬ä¸€ä¸ªä»»åŠ¡', 'rocket', 'achievement', 'submissions', 1, 50, 'common'),
('Rising Star', 'å®Œæˆ10ä¸ªä»»åŠ¡', 'star', 'achievement', 'submissions', 10, 100, 'uncommon'),
('Veteran', 'å®Œæˆ50ä¸ªä»»åŠ¡', 'award', 'achievement', 'submissions', 50, 250, 'rare'),
('Legend', 'å®Œæˆ100ä¸ªä»»åŠ¡', 'crown', 'achievement', 'submissions', 100, 500, 'epic'),
('Mythic', 'å®Œæˆ500ä¸ªä»»åŠ¡', 'gem', 'achievement', 'submissions', 500, 1000, 'legendary'),

-- è¿ç»­å¾½ç« 
('Consistent', 'è¿ç»­7å¤©æ´»è·ƒ', 'flame', 'streak', 'streak', 7, 100, 'uncommon'),
('Dedicated', 'è¿ç»­30å¤©æ´»è·ƒ', 'fire', 'streak', 'streak', 30, 300, 'rare'),
('Unstoppable', 'è¿ç»­100å¤©æ´»è·ƒ', 'zap', 'streak', 'streak', 100, 1000, 'legendary'),

-- è´¨é‡å¾½ç« 
('Quality First', 'è·å¾—10æ¬¡é«˜è´¨é‡è¯„åˆ†', 'thumbs-up', 'quality', 'high_quality', 10, 150, 'uncommon'),
('Perfectionist', 'è·å¾—50æ¬¡é«˜è´¨é‡è¯„åˆ†', 'check-circle', 'quality', 'high_quality', 50, 400, 'rare'),
('Master', 'è·å¾—100æ¬¡é«˜è´¨é‡è¯„åˆ†', 'shield', 'quality', 'high_quality', 100, 800, 'epic'),

-- ç‰¹æ®Šå¾½ç« 
('Early Adopter', 'æ—©æœŸç”¨æˆ·', 'clock', 'special', 'special', 1, 200, 'rare'),
('Bug Hunter', 'å‘ç°å¹¶æŠ¥å‘ŠBug', 'bug', 'special', 'special', 1, 150, 'uncommon'),
('Community Hero', 'å¸®åŠ©å…¶ä»–ç”¨æˆ·', 'heart', 'special', 'special', 1, 200, 'rare');

-- 10. åˆ›å»ºè®¡ç®— Success Score çš„å‡½æ•°
CREATE OR REPLACE FUNCTION calculate_success_score(p_user_id UUID)
RETURNS INTEGER AS $$
DECLARE
  v_quality INTEGER;
  v_consistency INTEGER;
  v_speed INTEGER;
  v_diversity INTEGER;
  v_total INTEGER;
BEGIN
  -- è®¡ç®—è´¨é‡åˆ† (åŸºäºé€šè¿‡ç‡å’Œè¯„åˆ†)
  SELECT COALESCE(
    ROUND(
      (CAST(approved_submissions AS FLOAT) / NULLIF(total_submissions, 0) * 50) +
      (quality_score * 0.5)
    ), 0
  ) INTO v_quality
  FROM success_scores WHERE user_id = p_user_id;
  
  -- è®¡ç®—ä¸€è‡´æ€§åˆ† (åŸºäºè¿ç»­å¤©æ•°)
  SELECT COALESCE(
    LEAST(current_streak * 2, 100), 0
  ) INTO v_consistency
  FROM success_scores WHERE user_id = p_user_id;
  
  -- è®¡ç®—é€Ÿåº¦åˆ† (åŸºäºå¹³å‡å®Œæˆæ—¶é—´)
  v_speed := 70; -- é»˜è®¤å€¼ï¼Œéœ€è¦æ ¹æ®å®é™…æ•°æ®è®¡ç®—
  
  -- è®¡ç®—å¤šæ ·æ€§åˆ† (åŸºäºä»»åŠ¡ç±»å‹è¦†ç›–)
  v_diversity := 60; -- é»˜è®¤å€¼ï¼Œéœ€è¦æ ¹æ®å®é™…æ•°æ®è®¡ç®—
  
  -- è®¡ç®—æ€»åˆ† (åŠ æƒå¹³å‡)
  v_total := ROUND(
    v_quality * 0.4 +
    v_consistency * 0.3 +
    v_speed * 0.15 +
    v_diversity * 0.15
  );
  
  -- æ›´æ–°åˆ†æ•°
  UPDATE success_scores SET
    quality_score = v_quality,
    consistency_score = v_consistency,
    speed_score = v_speed,
    diversity_score = v_diversity,
    total_score = v_total,
    updated_at = NOW()
  WHERE user_id = p_user_id;
  
  RETURN v_total;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 11. åˆ›å»ºæ›´æ–°è¿ç»­å¤©æ•°çš„å‡½æ•°
CREATE OR REPLACE FUNCTION update_user_streak(p_user_id UUID)
RETURNS void AS $$
DECLARE
  v_last_activity TIMESTAMPTZ;
  v_current_streak INTEGER;
  v_longest_streak INTEGER;
BEGIN
  SELECT last_activity_at, current_streak, longest_streak
  INTO v_last_activity, v_current_streak, v_longest_streak
  FROM success_scores WHERE user_id = p_user_id;
  
  IF v_last_activity IS NULL THEN
    -- æ–°ç”¨æˆ·
    INSERT INTO success_scores (user_id, current_streak, longest_streak, last_activity_at)
    VALUES (p_user_id, 1, 1, NOW());
  ELSIF v_last_activity::date = (NOW() - INTERVAL '1 day')::date THEN
    -- è¿ç»­æ´»è·ƒ
    v_current_streak := v_current_streak + 1;
    IF v_current_streak > v_longest_streak THEN
      v_longest_streak := v_current_streak;
    END IF;
    
    UPDATE success_scores SET
      current_streak = v_current_streak,
      longest_streak = v_longest_streak,
      last_activity_at = NOW()
    WHERE user_id = p_user_id;
  ELSIF v_last_activity::date < (NOW() - INTERVAL '1 day')::date THEN
    -- ä¸­æ–­è¿ç»­
    UPDATE success_scores SET
      current_streak = 1,
      last_activity_at = NOW()
    WHERE user_id = p_user_id;
  END IF;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 12. åˆ›å»ºæ£€æŸ¥å¹¶æˆäºˆå¾½ç« çš„å‡½æ•°
CREATE OR REPLACE FUNCTION check_and_award_badges(p_user_id UUID)
RETURNS TABLE(badge_id UUID, badge_name TEXT) AS $$
DECLARE
  v_badge RECORD;
  v_user_stats RECORD;
BEGIN
  -- è·å–ç”¨æˆ·ç»Ÿè®¡
  SELECT * INTO v_user_stats FROM success_scores WHERE user_id = p_user_id;
  
  -- éå†æ‰€æœ‰å¾½ç« æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ¡ä»¶
  FOR v_badge IN SELECT * FROM badges LOOP
    -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰è¯¥å¾½ç« 
    IF NOT EXISTS (SELECT 1 FROM user_badges WHERE user_id = p_user_id AND badge_id = v_badge.id) THEN
      -- æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ¡ä»¶
      IF (v_badge.requirement_type = 'submissions' AND v_user_stats.total_submissions >= v_badge.requirement_value) OR
         (v_badge.requirement_type = 'streak' AND v_user_stats.longest_streak >= v_badge.requirement_value) OR
         (v_badge.requirement_type = 'high_quality' AND v_user_stats.approved_submissions >= v_badge.requirement_value) THEN
        
        -- æˆäºˆå¾½ç« 
        INSERT INTO user_badges (user_id, badge_id) VALUES (p_user_id, v_badge.id);
        
        -- è¿”å›æ–°è·å¾—çš„å¾½ç« 
        badge_id := v_badge.id;
        badge_name := v_badge.name;
        RETURN NEXT;
      END IF;
    END IF;
  END LOOP;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 13. åˆ›å»ºç­‰çº§è®¡ç®—å‡½æ•°
CREATE OR REPLACE FUNCTION calculate_user_level(p_user_id UUID)
RETURNS TABLE(level INTEGER, title TEXT, xp_current INTEGER, xp_to_next INTEGER) AS $$
DECLARE
  v_total_xp INTEGER;
  v_level INTEGER;
  v_title TEXT;
  v_xp_for_level INTEGER;
  v_xp_to_next INTEGER;
BEGIN
  -- è·å–æ€»XP
  SELECT COALESCE(SUM(xp), 0) INTO v_total_xp
  FROM xp_events WHERE user_id = p_user_id;
  
  -- è®¡ç®—ç­‰çº§ (æ¯çº§éœ€è¦çš„XPé€’å¢)
  v_level := 1;
  v_xp_for_level := 0;
  
  WHILE v_total_xp >= (v_level * 100) LOOP
    v_xp_for_level := v_xp_for_level + (v_level * 100);
    v_level := v_level + 1;
  END LOOP;
  
  v_xp_to_next := (v_level * 100) - (v_total_xp - v_xp_for_level);
  
  -- ç¡®å®šç§°å·
  v_title := CASE
    WHEN v_level >= 50 THEN 'Grandmaster'
    WHEN v_level >= 40 THEN 'Master'
    WHEN v_level >= 30 THEN 'Expert'
    WHEN v_level >= 20 THEN 'Professional'
    WHEN v_level >= 10 THEN 'Skilled'
    WHEN v_level >= 5 THEN 'Apprentice'
    ELSE 'Novice'
  END;
  
  -- æ›´æ–°ç”¨æˆ·ç­‰çº§è¡¨
  INSERT INTO user_levels (user_id, level, xp_current, xp_to_next_level, title)
  VALUES (p_user_id, v_level, v_total_xp - v_xp_for_level, v_xp_to_next, v_title)
  ON CONFLICT (user_id) DO UPDATE SET
    level = v_level,
    xp_current = v_total_xp - v_xp_for_level,
    xp_to_next_level = v_xp_to_next,
    title = v_title,
    updated_at = NOW();
  
  RETURN QUERY SELECT v_level, v_title, v_total_xp - v_xp_for_level, v_xp_to_next;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

### ä»»åŠ¡ 5.2: Success Score å‰ç«¯å®ç°

**æ­¥éª¤ 1: åˆ›å»º Success Score Hook**

åˆ›å»ºæ–‡ä»¶ `src/hooks/useSuccessScore.ts`:

```typescript
// src/hooks/useSuccessScore.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { supabase } from '@/lib/supabase';
import { useAuth } from '@/contexts/AuthContext';

interface SuccessScore {
  total_score: number;
  current_streak: number;
  longest_streak: number;
  quality_score: number;
  consistency_score: number;
  speed_score: number;
  diversity_score: number;
  total_submissions: number;
  approved_submissions: number;
  rejected_submissions: number;
  grace_period_start: string | null;
  grace_period_reason: string | null;
}

interface UserLevel {
  level: number;
  title: string;
  xp_current: number;
  xp_to_next_level: number;
}

interface Badge {
  id: string;
  name: string;
  description: string;
  icon: string;
  category: string;
  rarity: string;
  earned_at?: string;
}

export function useSuccessScore() {
  const { user } = useAuth();
  const queryClient = useQueryClient();

  // è·å– Success Score
  const { data: score, isLoading: scoreLoading } = useQuery({
    queryKey: ['success-score', user?.id],
    queryFn: async () => {
      if (!user) return null;
      const { data, error } = await supabase
        .from('success_scores')
        .select('*')
        .eq('user_id', user.id)
        .single();
      
      if (error && error.code !== 'PGRST116') throw error;
      return data as SuccessScore | null;
    },
    enabled: !!user,
  });

  // è·å–ç”¨æˆ·ç­‰çº§
  const { data: level, isLoading: levelLoading } = useQuery({
    queryKey: ['user-level', user?.id],
    queryFn: async () => {
      if (!user) return null;
      const { data, error } = await supabase.rpc('calculate_user_level', {
        p_user_id: user.id,
      });
      
      if (error) throw error;
      return data[0] as UserLevel;
    },
    enabled: !!user,
  });

  // è·å–ç”¨æˆ·å¾½ç« 
  const { data: badges = [], isLoading: badgesLoading } = useQuery({
    queryKey: ['user-badges', user?.id],
    queryFn: async () => {
      if (!user) return [];
      const { data, error } = await supabase
        .from('user_badges')
        .select(`
          earned_at,
          badge:badges(*)
        `)
        .eq('user_id', user.id)
        .order('earned_at', { ascending: false });
      
      if (error) throw error;
      return data.map((item: any) => ({
        ...item.badge,
        earned_at: item.earned_at,
      })) as Badge[];
    },
    enabled: !!user,
  });

  // è·å–æ‰€æœ‰å¯ç”¨å¾½ç« 
  const { data: allBadges = [] } = useQuery({
    queryKey: ['all-badges'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('badges')
        .select('*')
        .order('requirement_value', { ascending: true });
      
      if (error) throw error;
      return data as Badge[];
    },
  });

  // ç”³è¯·å®½é™æœŸ
  const requestGracePeriod = useMutation({
    mutationFn: async (reason: string) => {
      if (!user) throw new Error('Not authenticated');
      
      const { error } = await supabase
        .from('success_scores')
        .update({
          grace_period_start: new Date().toISOString(),
          grace_period_reason: reason,
        })
        .eq('user_id', user.id);
      
      if (error) throw error;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['success-score'] });
    },
  });

  // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
  const getScoreProgress = (current: number, max: number = 100) => {
    return Math.min((current / max) * 100, 100);
  };

  // è·å–åˆ†æ•°ç­‰çº§
  const getScoreGrade = (score: number) => {
    if (score >= 90) return { grade: 'S', color: 'text-yellow-400' };
    if (score >= 80) return { grade: 'A', color: 'text-green-400' };
    if (score >= 70) return { grade: 'B', color: 'text-blue-400' };
    if (score >= 60) return { grade: 'C', color: 'text-gray-400' };
    return { grade: 'D', color: 'text-red-400' };
  };

  return {
    score,
    level,
    badges,
    allBadges,
    isLoading: scoreLoading || levelLoading || badgesLoading,
    requestGracePeriod,
    getScoreProgress,
    getScoreGrade,
  };
}
```

**æ­¥éª¤ 2: åˆ›å»º Success Score å±•ç¤ºç»„ä»¶**

åˆ›å»ºæ–‡ä»¶ `src/components/SuccessScoreCard.tsx`:

```typescript
// src/components/SuccessScoreCard.tsx
import { motion } from 'framer-motion';
import { 
  TrendingUp, 
  Flame, 
  Zap, 
  Target, 
  Award,
  Info,
  Calendar
} from 'lucide-react';
import { useSuccessScore } from '@/hooks/useSuccessScore';
import { Skeleton } from '@/components/Skeleton';

export function SuccessScoreCard() {
  const { score, level, getScoreProgress, getScoreGrade, isLoading } = useSuccessScore();

  if (isLoading) {
    return (
      <div className="bg-gray-800 rounded-xl p-6">
        <Skeleton className="h-6 w-32 mb-4" />
        <Skeleton className="h-24 w-24 rounded-full mx-auto mb-4" />
        <Skeleton className="h-4 w-full mb-2" />
        <Skeleton className="h-4 w-2/3" />
      </div>
    );
  }

  if (!score) {
    return (
      <div className="bg-gray-800 rounded-xl p-6 text-center">
        <Award className="w-12 h-12 mx-auto mb-3 text-gray-500" />
        <p className="text-gray-400">å®Œæˆç¬¬ä¸€ä¸ªä»»åŠ¡ä»¥å¼€å§‹è¿½è¸ªä½ çš„ Success Score</p>
      </div>
    );
  }

  const { grade, color } = getScoreGrade(score.total_score);

  return (
    <div className="bg-gray-800 rounded-xl p-6">
      {/* æ ‡é¢˜ */}
      <div className="flex items-center justify-between mb-6">
        <h3 className="text-lg font-semibold text-white">Success Score</h3>
        <button className="p-1 text-gray-400 hover:text-white">
          <Info className="w-4 h-4" />
        </button>
      </div>

      {/* ä¸»åˆ†æ•° */}
      <div className="flex items-center justify-center mb-6">
        <div className="relative">
          <svg className="w-32 h-32 transform -rotate-90">
            <circle
              cx="64"
              cy="64"
              r="56"
              fill="none"
              stroke="currentColor"
              strokeWidth="8"
              className="text-gray-700"
            />
            <motion.circle
              cx="64"
              cy="64"
              r="56"
              fill="none"
              stroke="currentColor"
              strokeWidth="8"
              strokeLinecap="round"
              className="text-blue-500"
              initial={{ strokeDasharray: '0 352' }}
              animate={{ 
                strokeDasharray: `${(score.total_score / 100) * 352} 352` 
              }}
              transition={{ duration: 1, ease: 'easeOut' }}
            />
          </svg>
          <div className="absolute inset-0 flex flex-col items-center justify-center">
            <span className={`text-4xl font-bold ${color}`}>{grade}</span>
            <span className="text-lg text-gray-400">{score.total_score}</span>
          </div>
        </div>
      </div>

      {/* è¿ç»­å¤©æ•° */}
      <div className="flex items-center justify-center gap-2 mb-6">
        <Flame className="w-5 h-5 text-orange-500" />
        <span className="text-white font-medium">{score.current_streak} å¤©è¿ç»­</span>
        <span className="text-gray-500">/ æœ€é«˜ {score.longest_streak} å¤©</span>
      </div>

      {/* ç»´åº¦åˆ†æ•° */}
      <div className="space-y-3">
        <ScoreDimension
          icon={<Target className="w-4 h-4" />}
          label="è´¨é‡"
          value={score.quality_score}
          color="blue"
        />
        <ScoreDimension
          icon={<TrendingUp className="w-4 h-4" />}
          label="ä¸€è‡´æ€§"
          value={score.consistency_score}
          color="green"
        />
        <ScoreDimension
          icon={<Zap className="w-4 h-4" />}
          label="é€Ÿåº¦"
          value={score.speed_score}
          color="yellow"
        />
        <ScoreDimension
          icon={<Award className="w-4 h-4" />}
          label="å¤šæ ·æ€§"
          value={score.diversity_score}
          color="purple"
        />
      </div>

      {/* å®½é™æœŸçŠ¶æ€ */}
      {score.grace_period_start && (
        <div className="mt-4 p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
          <div className="flex items-center gap-2 text-yellow-500">
            <Calendar className="w-4 h-4" />
            <span className="text-sm font-medium">å®½é™æœŸè¿›è¡Œä¸­</span>
          </div>
          <p className="text-xs text-gray-400 mt-1">{score.grace_period_reason}</p>
        </div>
      )}

      {/* ç­‰çº§ä¿¡æ¯ */}
      {level && (
        <div className="mt-4 pt-4 border-t border-gray-700">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm text-gray-400">ç­‰çº§ {level.level}</span>
            <span className="text-sm text-gray-400">{level.title}</span>
          </div>
          <div className="h-2 bg-gray-700 rounded-full overflow-hidden">
            <motion.div
              className="h-full bg-gradient-to-r from-blue-500 to-purple-500"
              initial={{ width: 0 }}
              animate={{ 
                width: `${(level.xp_current / (level.xp_current + level.xp_to_next_level)) * 100}%` 
              }}
              transition={{ duration: 0.5 }}
            />
          </div>
          <p className="text-xs text-gray-500 mt-1 text-right">
            {level.xp_current} / {level.xp_current + level.xp_to_next_level} XP
          </p>
        </div>
      )}
    </div>
  );
}

// ç»´åº¦åˆ†æ•°ç»„ä»¶
function ScoreDimension({ 
  icon, 
  label, 
  value, 
  color 
}: { 
  icon: React.ReactNode; 
  label: string; 
  value: number; 
  color: string;
}) {
  const colorClasses = {
    blue: 'bg-blue-500',
    green: 'bg-green-500',
    yellow: 'bg-yellow-500',
    purple: 'bg-purple-500',
  };

  return (
    <div className="flex items-center gap-3">
      <div className="text-gray-400">{icon}</div>
      <div className="flex-1">
        <div className="flex items-center justify-between mb-1">
          <span className="text-sm text-gray-300">{label}</span>
          <span className="text-sm text-white font-medium">{value}</span>
        </div>
        <div className="h-1.5 bg-gray-700 rounded-full overflow-hidden">
          <motion.div
            className={`h-full ${colorClasses[color as keyof typeof colorClasses]}`}
            initial={{ width: 0 }}
            animate={{ width: `${value}%` }}
            transition={{ duration: 0.5, delay: 0.2 }}
          />
        </div>
      </div>
    </div>
  );
}
```

---

## ä¸ƒã€Phase 6: æµ‹è¯•å’Œæ”¶å°¾ï¼ˆWeek 9-10ï¼‰

> **ç›®æ ‡**: å®Œå–„æµ‹è¯•è¦†ç›–ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®š

### ä»»åŠ¡ 6.1: E2E æµ‹è¯•ä¿®å¤

**æ­¥éª¤ 1: æ›´æ–°æµ‹è¯•é…ç½®**

ä¿®æ”¹æ–‡ä»¶ `playwright.config.ts`:

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html', { outputFolder: 'playwright-report' }],
    ['json', { outputFile: 'test-results.json' }],
  ],
  
  use: {
    baseURL: process.env.PLAYWRIGHT_TEST_BASE_URL || 'http://localhost:5173',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],

  webServer: process.env.PLAYWRIGHT_TEST_BASE_URL ? undefined : {
    command: 'pnpm dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
  },
});
```

**æ­¥éª¤ 2: åˆ›å»ºæµ‹è¯•å·¥å…·å‡½æ•°**

åˆ›å»ºæ–‡ä»¶ `tests/utils/test-helpers.ts`:

```typescript
// tests/utils/test-helpers.ts
import { Page, expect } from '@playwright/test';

// ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
export async function waitForPageLoad(page: Page) {
  await page.waitForLoadState('networkidle');
  await page.waitForLoadState('domcontentloaded');
}

// ç™»å½•è¾…åŠ©å‡½æ•°
export async function login(page: Page, email: string, password: string) {
  await page.goto('/');
  await page.click('[data-testid="login-button"]');
  await page.waitForSelector('[data-testid="auth-modal"]');
  await page.fill('[data-testid="email-input"]', email);
  await page.fill('[data-testid="password-input"]', password);
  await page.click('[data-testid="submit-button"]');
  await page.waitForSelector('[data-testid="user-menu"]', { timeout: 10000 });
}

// ç™»å‡ºè¾…åŠ©å‡½æ•°
export async function logout(page: Page) {
  await page.click('[data-testid="user-menu"]');
  await page.click('[data-testid="logout-button"]');
  await page.waitForURL('/');
}

// æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§
export async function isVisible(page: Page, selector: string): Promise<boolean> {
  try {
    await page.waitForSelector(selector, { timeout: 5000 });
    return true;
  } catch {
    return false;
  }
}

// ç­‰å¾… Toast æ¶ˆæ¯
export async function waitForToast(page: Page, message: string) {
  await page.waitForSelector(`text=${message}`, { timeout: 5000 });
}

// æˆªå›¾å¹¶ä¿å­˜
export async function takeScreenshot(page: Page, name: string) {
  await page.screenshot({ path: `screenshots/${name}.png`, fullPage: true });
}

// æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
export async function simulateSlowNetwork(page: Page) {
  const client = await page.context().newCDPSession(page);
  await client.send('Network.emulateNetworkConditions', {
    offline: false,
    downloadThroughput: 500 * 1024 / 8,
    uploadThroughput: 500 * 1024 / 8,
    latency: 400,
  });
}

// æ¸…ç†æµ‹è¯•æ•°æ®
export async function cleanupTestData(page: Page) {
  // æ¸…ç† localStorage
  await page.evaluate(() => {
    localStorage.clear();
    sessionStorage.clear();
  });
}
```

**æ­¥éª¤ 3: ä¿®å¤è®¤è¯æµ‹è¯•**

ä¿®æ”¹æ–‡ä»¶ `tests/e2e/auth.spec.ts`:

```typescript
// tests/e2e/auth.spec.ts
import { test, expect } from '@playwright/test';
import { waitForPageLoad, login, logout, cleanupTestData } from '../utils/test-helpers';

test.describe('Authentication', () => {
  test.beforeEach(async ({ page }) => {
    await cleanupTestData(page);
  });

  test('should display login modal when clicking login button', async ({ page }) => {
    await page.goto('/');
    await waitForPageLoad(page);
    
    await page.click('[data-testid="login-button"]');
    await expect(page.locator('[data-testid="auth-modal"]')).toBeVisible();
    await expect(page.locator('[data-testid="email-input"]')).toBeVisible();
    await expect(page.locator('[data-testid="password-input"]')).toBeVisible();
  });

  test('should show error for invalid email format', async ({ page }) => {
    await page.goto('/');
    await page.click('[data-testid="login-button"]');
    
    await page.fill('[data-testid="email-input"]', 'invalid-email');
    await page.fill('[data-testid="password-input"]', 'password123');
    await page.click('[data-testid="submit-button"]');
    
    await expect(page.locator('[data-testid="email-error"]')).toBeVisible();
  });

  test('should show error for empty fields', async ({ page }) => {
    await page.goto('/');
    await page.click('[data-testid="login-button"]');
    
    await page.click('[data-testid="submit-button"]');
    
    await expect(page.locator('[data-testid="email-error"]')).toBeVisible();
  });

  test('should show error for wrong credentials', async ({ page }) => {
    await page.goto('/');
    await page.click('[data-testid="login-button"]');
    
    await page.fill('[data-testid="email-input"]', 'wrong@email.com');
    await page.fill('[data-testid="password-input"]', 'wrongpassword');
    await page.click('[data-testid="submit-button"]');
    
    await expect(page.locator('[data-testid="error-message"]')).toBeVisible({ timeout: 10000 });
  });

  test('should switch between login and register modes', async ({ page }) => {
    await page.goto('/');
    await page.click('[data-testid="login-button"]');
    
    // åˆ‡æ¢åˆ°æ³¨å†Œ
    await page.click('text=ç«‹å³æ³¨å†Œ');
    await expect(page.locator('[data-testid="username-input"]')).toBeVisible();
    await expect(page.locator('[data-testid="confirm-password-input"]')).toBeVisible();
    
    // åˆ‡æ¢å›ç™»å½•
    await page.click('text=ç«‹å³ç™»å½•');
    await expect(page.locator('[data-testid="username-input"]')).not.toBeVisible();
  });

  test('should close modal when clicking close button', async ({ page }) => {
    await page.goto('/');
    await page.click('[data-testid="login-button"]');
    await expect(page.locator('[data-testid="auth-modal"]')).toBeVisible();
    
    await page.click('[aria-label="å…³é—­"]');
    await expect(page.locator('[data-testid="auth-modal"]')).not.toBeVisible();
  });

  test('should redirect unauthenticated users from protected routes', async ({ page }) => {
    await page.goto('/dashboard');
    await waitForPageLoad(page);
    
    // åº”è¯¥é‡å®šå‘åˆ°é¦–é¡µæˆ–æ˜¾ç¤ºç™»å½•æç¤º
    await expect(page).toHaveURL('/');
  });
});
```

**æ­¥éª¤ 4: ä¿®å¤ä»ªè¡¨æ¿æµ‹è¯•**

ä¿®æ”¹æ–‡ä»¶ `tests/e2e/dashboard.spec.ts`:

```typescript
// tests/e2e/dashboard.spec.ts
import { test, expect } from '@playwright/test';
import { waitForPageLoad, login, cleanupTestData } from '../utils/test-helpers';

test.describe('Dashboard', () => {
  const testUser = {
    email: process.env.TEST_USER_EMAIL || 'test@example.com',
    password: process.env.TEST_USER_PASSWORD || 'testpassword123',
  };

  test.beforeEach(async ({ page }) => {
    await cleanupTestData(page);
    // å¦‚æœæœ‰æµ‹è¯•è´¦å·ï¼Œå…ˆç™»å½•
    if (process.env.TEST_USER_EMAIL) {
      await login(page, testUser.email, testUser.password);
    }
  });

  test('should display user stats section', async ({ page }) => {
    await page.goto('/dashboard');
    await waitForPageLoad(page);
    
    await expect(page.locator('[data-testid="user-stats"]')).toBeVisible();
  });

  test('should display task statistics', async ({ page }) => {
    await page.goto('/dashboard');
    await waitForPageLoad(page);
    
    await expect(page.locator('[data-testid="active-tasks-count"]')).toBeVisible();
    await expect(page.locator('[data-testid="completed-tasks-count"]')).toBeVisible();
  });

  test('should display recent activity', async ({ page }) => {
    await page.goto('/dashboard');
    await waitForPageLoad(page);
    
    await expect(page.locator('[data-testid="recent-activity"]')).toBeVisible();
  });

  test('should open notifications panel', async ({ page }) => {
    await page.goto('/dashboard');
    await waitForPageLoad(page);
    
    await page.click('[data-testid="notifications-button"]');
    await expect(page.locator('[data-testid="notifications-panel"]')).toBeVisible();
  });

  test('should close notifications panel when clicking outside', async ({ page }) => {
    await page.goto('/dashboard');
    await waitForPageLoad(page);
    
    await page.click('[data-testid="notifications-button"]');
    await expect(page.locator('[data-testid="notifications-panel"]')).toBeVisible();
    
    // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸ
    await page.click('body', { position: { x: 10, y: 10 } });
    await expect(page.locator('[data-testid="notifications-panel"]')).not.toBeVisible();
  });

  test('should navigate to tasks page', async ({ page }) => {
    await page.goto('/dashboard');
    await waitForPageLoad(page);
    
    await page.click('[data-testid="view-all-tasks"]');
    await expect(page).toHaveURL(/\/tasks/);
  });

  test('should display user avatar', async ({ page }) => {
    await page.goto('/dashboard');
    await waitForPageLoad(page);
    
    await expect(page.locator('[data-testid="user-avatar"]')).toBeVisible();
  });

  test('should refresh dashboard data', async ({ page }) => {
    await page.goto('/dashboard');
    await waitForPageLoad(page);
    
    const refreshButton = page.locator('[data-testid="refresh-dashboard"]');
    if (await refreshButton.isVisible()) {
      await refreshButton.click();
      // ç­‰å¾…åˆ·æ–°å®Œæˆ
      await page.waitForTimeout(1000);
    }
  });

  test('should load dashboard within acceptable time', async ({ page }) => {
    const startTime = Date.now();
    await page.goto('/dashboard');
    await waitForPageLoad(page);
    const loadTime = Date.now() - startTime;
    
    // é¡µé¢åº”åœ¨5ç§’å†…åŠ è½½å®Œæˆ
    expect(loadTime).toBeLessThan(5000);
  });
});
```

---

### ä»»åŠ¡ 6.2: å•å…ƒæµ‹è¯•é…ç½®

**æ­¥éª¤ 1: å®‰è£…æµ‹è¯•ä¾èµ–**

```bash
pnpm add -D vitest @testing-library/react @testing-library/jest-dom @testing-library/user-event jsdom
```

**æ­¥éª¤ 2: é…ç½® Vitest**

åˆ›å»ºæ–‡ä»¶ `vitest.config.ts`:

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react-swc';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./tests/setup.ts'],
    include: ['src/**/*.{test,spec}.{ts,tsx}'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'tests/',
        '**/*.d.ts',
        '**/*.config.*',
        '**/types/*',
      ],
    },
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
});
```

**æ­¥éª¤ 3: åˆ›å»ºæµ‹è¯•è®¾ç½®æ–‡ä»¶**

åˆ›å»ºæ–‡ä»¶ `tests/setup.ts`:

```typescript
// tests/setup.ts
import '@testing-library/jest-dom';
import { cleanup } from '@testing-library/react';
import { afterEach, vi } from 'vitest';

// æ¯ä¸ªæµ‹è¯•åæ¸…ç†
afterEach(() => {
  cleanup();
});

// Mock matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation((query) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});

// Mock IntersectionObserver
class MockIntersectionObserver {
  observe = vi.fn();
  disconnect = vi.fn();
  unobserve = vi.fn();
}

Object.defineProperty(window, 'IntersectionObserver', {
  writable: true,
  value: MockIntersectionObserver,
});

// Mock ResizeObserver
class MockResizeObserver {
  observe = vi.fn();
  disconnect = vi.fn();
  unobserve = vi.fn();
}

Object.defineProperty(window, 'ResizeObserver', {
  writable: true,
  value: MockResizeObserver,
});
```

**æ­¥éª¤ 4: åˆ›å»ºç¤ºä¾‹å•å…ƒæµ‹è¯•**

åˆ›å»ºæ–‡ä»¶ `src/lib/validations.test.ts`:

```typescript
// src/lib/validations.test.ts
import { describe, it, expect } from 'vitest';
import { loginSchema, registerSchema, emailSchema, passwordSchema } from './validations';

describe('Validation Schemas', () => {
  describe('emailSchema', () => {
    it('should accept valid email', () => {
      const result = emailSchema.safeParse('test@example.com');
      expect(result.success).toBe(true);
    });

    it('should reject invalid email', () => {
      const result = emailSchema.safeParse('invalid-email');
      expect(result.success).toBe(false);
    });

    it('should reject empty email', () => {
      const result = emailSchema.safeParse('');
      expect(result.success).toBe(false);
    });
  });

  describe('passwordSchema', () => {
    it('should accept valid password', () => {
      const result = passwordSchema.safeParse('Password123');
      expect(result.success).toBe(true);
    });

    it('should reject short password', () => {
      const result = passwordSchema.safeParse('Pass1');
      expect(result.success).toBe(false);
    });

    it('should reject password without uppercase', () => {
      const result = passwordSchema.safeParse('password123');
      expect(result.success).toBe(false);
    });

    it('should reject password without lowercase', () => {
      const result = passwordSchema.safeParse('PASSWORD123');
      expect(result.success).toBe(false);
    });

    it('should reject password without number', () => {
      const result = passwordSchema.safeParse('PasswordABC');
      expect(result.success).toBe(false);
    });
  });

  describe('loginSchema', () => {
    it('should accept valid login data', () => {
      const result = loginSchema.safeParse({
        email: 'test@example.com',
        password: 'anypassword',
      });
      expect(result.success).toBe(true);
    });

    it('should reject invalid login data', () => {
      const result = loginSchema.safeParse({
        email: 'invalid',
        password: '',
      });
      expect(result.success).toBe(false);
    });
  });

  describe('registerSchema', () => {
    it('should accept valid registration data', () => {
      const result = registerSchema.safeParse({
        email: 'test@example.com',
        username: 'testuser',
        password: 'Password123',
        confirmPassword: 'Password123',
      });
      expect(result.success).toBe(true);
    });

    it('should reject mismatched passwords', () => {
      const result = registerSchema.safeParse({
        email: 'test@example.com',
        username: 'testuser',
        password: 'Password123',
        confirmPassword: 'Password456',
      });
      expect(result.success).toBe(false);
    });

    it('should reject invalid username', () => {
      const result = registerSchema.safeParse({
        email: 'test@example.com',
        username: 'ab', // too short
        password: 'Password123',
        confirmPassword: 'Password123',
      });
      expect(result.success).toBe(false);
    });
  });
});
```

**æ­¥éª¤ 5: æ·»åŠ  npm scripts**

åœ¨ `package.json` ä¸­æ·»åŠ :

```json
{
  "scripts": {
    "test": "vitest",
    "test:run": "vitest run",
    "test:coverage": "vitest run --coverage",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:all": "pnpm test:run && pnpm test:e2e"
  }
}
```

---

## å…«ã€éªŒè¯æ¸…å•

### å®Œæ•´éªŒè¯æ¸…å•

| Phase | ä»»åŠ¡ | éªŒè¯æ–¹æ³• | é¢„æœŸç»“æœ |
|-------|------|----------|----------|
| 1 | Sentry é›†æˆ | è§¦å‘é”™è¯¯æŸ¥çœ‹ Dashboard | é”™è¯¯è¢«è®°å½• |
| 1 | PostHog é›†æˆ | æ‰§è¡Œæ“ä½œæŸ¥çœ‹äº‹ä»¶ | äº‹ä»¶è¢«è¿½è¸ª |
| 1 | Web Vitals | æŸ¥çœ‹æ§åˆ¶å°/PostHog | æŒ‡æ ‡è¢«è®°å½• |
| 2 | ç™»å‡ºæµç¨‹ | ç™»å‡ºåæ£€æŸ¥çŠ¶æ€ | å®Œå…¨æ¸…é™¤ |
| 2 | é€šçŸ¥é¢æ¿ | ç‚¹å‡»æ‰“å¼€/å…³é—­ | æ­£å¸¸å·¥ä½œ |
| 2 | è¡¨å•éªŒè¯ | è¾“å…¥æ— æ•ˆæ•°æ® | æ˜¾ç¤ºé”™è¯¯ |
| 2 | ä»£ç åˆ†å‰² | æ£€æŸ¥ Network | æŒ‰éœ€åŠ è½½ |
| 3 | Admin Dashboard | ç®¡ç†å‘˜è®¿é—® | æ­£å¸¸æ˜¾ç¤º |
| 3 | AI Review | æäº¤å†…å®¹ | è¿”å›è¯„åˆ† |
| 4 | SEO | æ£€æŸ¥ Schema | æ­£ç¡®æ¸²æŸ“ |
| 4 | å¯è®¿é—®æ€§ | é”®ç›˜å¯¼èˆª | å¯å®Œå…¨æ“ä½œ |
| 5 | Success Score | å®Œæˆä»»åŠ¡ | åˆ†æ•°æ›´æ–° |
| 5 | å¾½ç« ç³»ç»Ÿ | è¾¾æˆæ¡ä»¶ | è·å¾—å¾½ç«  |
| 6 | E2E æµ‹è¯• | è¿è¡Œæµ‹è¯• | 80%+ é€šè¿‡ |
| 6 | å•å…ƒæµ‹è¯• | è¿è¡Œæµ‹è¯• | 90%+ é€šè¿‡ |

### è¿è¡ŒéªŒè¯å‘½ä»¤

```bash
# 1. è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test:all

# 2. æ£€æŸ¥æ„å»º
pnpm build

# 3. æ£€æŸ¥ Bundle å¤§å°
npx vite-bundle-visualizer

# 4. è¿è¡Œ Lighthouse
npx lighthouse https://follow.ai --output html --output-path ./lighthouse-report.html

# 5. æ£€æŸ¥å¯è®¿é—®æ€§
npx axe-cli https://follow.ai

# 6. éªŒè¯ Schema
# ä½¿ç”¨ Google Rich Results Test: https://search.google.com/test/rich-results
```

---

## é™„å½•

### A. ç¯å¢ƒå˜é‡æ¸…å•

```env
# Supabase
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# ç›‘æ§
VITE_SENTRY_DSN=your_sentry_dsn
VITE_POSTHOG_KEY=your_posthog_key
VITE_POSTHOG_HOST=https://app.posthog.com

# AI Review
OPENAI_API_KEY=your_openai_api_key

# åº”ç”¨
VITE_APP_VERSION=1.0.0
VITE_APP_URL=https://follow.ai

# æµ‹è¯•
TEST_USER_EMAIL=test@example.com
TEST_USER_PASSWORD=testpassword123
PLAYWRIGHT_TEST_BASE_URL=https://follow.ai
```

### B. ä¾èµ–ç‰ˆæœ¬

```json
{
  "dependencies": {
    "@sentry/react": "^8.0.0",
    "@hookform/resolvers": "^3.3.0",
    "posthog-js": "^1.100.0",
    "react-helmet-async": "^2.0.0",
    "react-hook-form": "^7.50.0",
    "web-vitals": "^4.0.0",
    "zod": "^3.22.0"
  },
  "devDependencies": {
    "@playwright/test": "^1.41.0",
    "@testing-library/jest-dom": "^6.4.0",
    "@testing-library/react": "^14.2.0",
    "@testing-library/user-event": "^14.5.0",
    "vitest": "^1.2.0"
  }
}
```

### C. æ–‡ä»¶ç»“æ„

```
follow-ai/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”‚   â”œâ”€â”€ StatsCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PendingReviewsTable.tsx
â”‚   â”‚   â”‚   â””â”€â”€ RecentActivityList.tsx
â”‚   â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”‚   â””â”€â”€ AccessibleButton.tsx
â”‚   â”‚   â”œâ”€â”€ AuthModal.tsx
â”‚   â”‚   â”œâ”€â”€ ErrorFallback.tsx
â”‚   â”‚   â”œâ”€â”€ NotificationCenter.tsx
â”‚   â”‚   â”œâ”€â”€ SEO.tsx
â”‚   â”‚   â”œâ”€â”€ Skeleton.tsx
â”‚   â”‚   â””â”€â”€ SuccessScoreCard.tsx
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useAIReview.ts
â”‚   â”‚   â””â”€â”€ useSuccessScore.ts
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ a11y.ts
â”‚   â”‚   â”œâ”€â”€ posthog.ts
â”‚   â”‚   â”œâ”€â”€ schema.ts
â”‚   â”‚   â”œâ”€â”€ sentry.ts
â”‚   â”‚   â”œâ”€â”€ validations.ts
â”‚   â”‚   â””â”€â”€ web-vitals.ts
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â””â”€â”€ admin/
â”‚   â”‚       â””â”€â”€ Dashboard.tsx
â”‚   â””â”€â”€ contexts/
â”‚       â””â”€â”€ AuthContext.tsx
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ functions/
â”‚   â”‚   â””â”€â”€ ai-review/
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â””â”€â”€ migrations/
â”‚       â”œâ”€â”€ 20260108_admin_roles.sql
â”‚       â””â”€â”€ 20260108_success_score.sql
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ e2e/
â”‚   â”‚   â”œâ”€â”€ auth.spec.ts
â”‚   â”‚   â””â”€â”€ dashboard.spec.ts
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ test-helpers.ts
â”‚   â””â”€â”€ setup.ts
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ generate-sitemap.ts
â”œâ”€â”€ playwright.config.ts
â””â”€â”€ vitest.config.ts
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2026å¹´1æœˆ8æ—¥  
**ä½œè€…**: Manus AI  
